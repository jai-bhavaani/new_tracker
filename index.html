<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TrackeX</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --bg:#e9f1ff;
      --card:#ffffff;
      --accent:#2b7cff;
      --accent-dark:#1a5ecf;
      --muted:#000000;
      --success:#d4e4ff;
      --danger:#e04f5f;
      --glass: rgba(255,255,255,0.6);
      --shadow: 0 6px 18px rgba(34,60,80,0.08);
      --max-width:1100px;
    }
    /* Dark Mode Toggle */
    .dark { --bg:#0c0c0c; --card: #070707; --accent:#3991fc; --accent-dark:#3e84f4; --muted:#757575; color:#e6eef8; }
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:#007bff;background:linear-gradient(180deg,var(--bg),#dfeeff); }
    .app{max-width:var(--max-width);padding-bottom:80px;    box-sizing:border-box;}
    header.main-header{display:flex;align-items:center;justify-content:space-between;padding:1rem }
    header .title{display:flex;gap:0.75rem;align-items:center}
    header h1{margin:0;font-size:1.1rem;color:var(--accent-dark)}
    .card{background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:1rem;margin-bottom:1rem}
    .row{display:flex;gap:1rem;align-items:center}
    .col{flex:1}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent-dark));color:white;padding:.6rem .9rem;border-radius:10px;border:none;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:.5rem}
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn.ghost{background:transparent;color:var(--accent-dark);border:1px solid rgba(0,0,0,0.06)}
    .btn.active { background: var(--success); }
    .small{padding:.35rem .6rem;font-size:.9rem;border-radius:8px}
    input, select, textarea{width:100%;padding:.6rem;border-radius:8px;border:1px solid rgba(10,20,40,0.06);box-sizing:border-box;background:transparent}
    .muted{color:var(--muted);font-size:.9rem}
    #todayQuote { font-size: 1.2rem; font-style: italic; }
    /* Sections */
    .section{display:none;opacity:0;transform:translateY(6px);transition:all .25s ease-in-out;padding-bottom:1rem}
    .section.active{display:block;opacity:1;transform:none}
    /* Bottom nav */
    .bottom-nav{position:fixed;left:0;right:0;bottom:14px;display:flex;justify-content:center;pointer-events:none}
    .bottom-nav-inner{width:100%;max-width:var(--max-width);background:linear-gradient(180deg, rgb(255, 255, 255), rgba(255,255,255,0.75));border-radius:18px;box-shadow:0 12px 30px rgba(10,20,40,0.12);display:flex;justify-content:space-around;padding:.6rem;pointer-events:auto}
    .nav-item{text-align:center;padding:.45rem .35rem;border-radius:12px;color:var(--muted);cursor:pointer}
    .nav-item.active{background:linear-gradient(90deg, rgba(4, 100, 255, 0.12), rgba(26,94,207,0.07));color:var(--accent-dark);font-weight:700}
    .nav-item i{display:block;font-size:1.2rem;margin-bottom:4px}
    /* NEW: Class for nav text */
    .nav-text {
        font-size: 0.75rem;
        display: block;
        line-height: 1; /* Tighter spacing */
    }
    /* Tasks & Targets */
    .task-item, .target-item {flex-wrap: wrap;gap:.75rem;padding:.2rem;border-radius:1px;align-items:center;border:1px solid rgba(10,20,40,0.04);transition:all .18s}
    .task-item:hover, .target-item:hover {transform:translateY(-4px)}
    .task-completed, .target-completed {opacity:.55;text-decoration:line-through;background:linear-gradient(90deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01))}
    .task-checkbox, .target-checkbox {transform:scale(1.15);}
    .task-meta{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:.5rem;font-size:.85rem;color:var(--muted)}
    .priority-low{color:#2dbe60}
    .priority-medium{color:#ffb020}
    .priority-high{color:var(--danger)}
    .task-actions, .target-actions {margin-left:auto;display:flex;gap:.4rem}
    
    /* New styles for Skill/Project items */
    .skill-item, .project-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.6rem 0.8rem;
        border-radius: 8px;
        background: rgba(0,0,0,0.02);
        margin-bottom: 0.5rem;
    }
    .dark .skill-item, .dark .project-item {
        background: rgba(255,255,255,0.05);
    }
    
    .tasks-layout {
        display: flex;
        gap: 1rem;
        word-wrap: break-word; /* Breaks long words if needed */
        overflow-wrap: break-word; /* Modern way to break words */
        text-overflow: ellipsis;
        flex-wrap: wrap;
    }
    .tasks-layout > .card {
        flex: 1;
        max-width: 490px;
    }

    /* Dashboard summary */
    .summary-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem}
    .summary-card{padding:1rem;border-radius:12px;background:linear-gradient(180deg,#2388fa,#070707);box-shadow:var(--shadow);display:flex;flex-direction:column;gap:.5rem}
    .chart-wrap{background:var(--card);border-radius:12px;padding:1rem;box-shadow:var(--shadow);margin-bottom:1rem}
   
    /* Helper classes for forms */
    .form-row {
        display: flex;
        gap: .5rem;
        margin-top: .5rem;
        flex-wrap: wrap;
    }
    .form-row > * {
        flex: 1 1 auto;
    }

    /* Analytics filters */
    .filters{display:flex;gap:.5rem;flex-wrap:wrap}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:84px;background:#0c1726;color:white;padding:.6rem 1rem;border-radius:8px;display:none;z-index:9999}
   
    .analytics-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    /* AI Modal Styles */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    .modal-content { background-color: var(--card); margin: 10% auto; padding: 24px; border: 1px solid rgba(0,0,0,0.1); width: 90%; max-width: 600px; border-radius: 12px; box-shadow: var(--shadow); position: relative; animation: fadeIn .3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    .close-modal { color: var(--muted); position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; }
    .close-modal:hover, .close-modal:focus { color: var(--danger); text-decoration: none; cursor: pointer; }
    #modalContent .subtask-item { display: flex; align-items: center; justify-content: space-between; padding: .6rem 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .dark #modalContent .subtask-item { border-bottom: 1px solid rgba(255,255,255,0.1); }
    #modalContent .subtask-item:last-child { border-bottom: none; }

    /* AI Chat Styles */
    .chat-message { padding: .75rem 1rem; border-radius: 12px; max-width: 80%; line-height: 1.5; word-wrap: break-word; }
    .chat-user { background-color: var(--accent); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
    .chat-ai { background-color: #f0f4f9; color: #333; align-self: flex-start; border-bottom-left-radius: 4px; }
    .dark .chat-ai { background-color: #1a2433; color: #e6eef8; }
    .typing-indicator span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: var(--muted); animation: bounce 1.4s infinite ease-in-out both; }
    .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
    .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
   
    /* Floating Action Button */
    .fab-add-task {
        position: fixed;
        bottom: 90px; /* Above the nav bar */
        right: 20px;
        width: 56px;
        height: 56px;
        background: linear-gradient(90deg,var(--accent),var(--accent-dark));
        color: white;
        border-radius: 50%;
        border: none;
        font-size: 24px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        cursor: pointer;
        z-index: 998; /* Below modals (1000) but above content */
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease;
    }
    .fab-add-task:hover {
        transform: scale(1.05);
    }

    /* Mood Tracker */
    .mood-selector { display: flex; justify-content: space-around; margin-top: 1rem; }
    .mood-option { font-size: 2rem; cursor: pointer; transition: transform 0.2s ease; padding: 0.5rem; border-radius: 50%; }
    .mood-option:hover { transform: scale(1.2); }
    .mood-option.selected { background-color: rgba(43, 124, 255, 0.15); transform: scale(1.1); }

    /* NEW: Learning Journal Styles */
    .learning-item {
        position: relative; /* For delete button */
        padding: 1rem;
        border-radius: 12px;
        background: rgba(0,0,0,0.02);
        margin-bottom: 0.75rem;
    }
    .dark .learning-item { background: rgba(255,255,255,0.05); }
    .tag-badge {
        font-size: 0.8rem;
        background: var(--accent);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
    }
    .tag-filter {
        background: transparent;
        border: 1px solid rgba(10,20,40,0.06);
        color: var(--muted);
        padding: 0.3rem 0.6rem;
        border-radius: 8px;
        cursor: pointer;
    }
    .dark .tag-filter { border-color: rgba(255, 255, 255, 0.2); }
    .tag-filter.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
    }
    /* End New Styles */

    /* Dark Mode Fixes */
    .dark input, .dark select, .dark textarea {
        border-color: rgba(255, 255, 255, 0.2);
        color: #e6eef8;
    }
    .dark ::placeholder {
        color: var(--muted);
        opacity: 1; /* Override browser defaults */
    }
    .dark .btn.ghost {
        color: var(--accent);
        border-color: rgba(255, 255, 255, 0.2);
    }

    /* Responsive */
    @media(max-width:900px){ .tasks-grid{grid-template-columns:1fr} .summary-cards{grid-template-columns:repeat(2,1fr)} header h1{font-size:1rem} .analytics-grid { grid-template-columns: 1fr; } }
    @media(max-width:768px){ 
        .tasks-layout { flex-direction: column; }
        /* Stack form inputs for easier use on mobile */
        .task-form-inputs { flex-direction: column; align-items: stretch; }
        .form-row { flex-direction: column; }
        .form-row > .btn { justify-content: center; }
    }
    @media(max-width:560px){ 
        .main-header { flex-direction: column; align-items: center; gap: 1rem; text-align: center; }
        .summary-cards{grid-template-columns:1fr} 
        .bottom-nav-inner{padding:.4rem .2rem} /* Adjusted padding */
        .nav-item i{
            font-size:1.1rem; /* Slightly larger icons */
            margin-bottom: 0; /* Remove margin since text is gone */
        }
        .nav-item {
            padding: .4rem; /* Adjust item padding */
        }
        /* NEW: Hide nav text on small screens */
        .nav-text {
            display: none;
        }
        /* Hide button text on mobile to save space */
        .btn-text { display: none; }
        .header-buttons .btn.small { padding: .6rem; }
    }
  </style>
</head>
<body>
<div class="app" id="app">
  <header class="main-header">
    <div class="title">
      <div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:white;font-weight:700">X</div>
      <div style="font-size: 40px; font-weight: 600; font-family:'Times New Roman', Times, serif;">
        TrackeX
      </div>
      <!-- ADDED XP Counter -->
      <div style="padding: 0.5rem 0.8rem; background: rgba(0,0,0,0.05); border-radius: 8px; font-weight: 600; margin-left: 1rem; color: var(--accent-dark);">
        XP: <span id="xpPoints">0</span>
      </div>
    </div>
    <div class="muted" id="subTitle">Motivation to do more — live stats</div>
    <div class="header-buttons" style="display:flex;gap:.6rem;align-items:center">
      <button class="btn small ghost" id="notificationBtn" title="Enable Task Reminders"><i class="fas fa-bell"></i><span class="btn-text">&nbsp;Enable Reminders</span></button>
      <button class="btn small" id="exportBtn" title="Export CSV"><i class="fas fa-file-export"></i><span class="btn-text">&nbsp;Export</span></button>
      <button class="btn small ghost" id="darkToggle" title="Toggle Dark Mode"><i class="fas fa-moon"></i></button>
    </div>
  </header>

  <!-- Home -->
  <section id="homeSection" class="section active card">
     <div style="display:flex;justify-content:space-between;align-items:center;">
       <div>
         <h1 style="margin:.2rem 0 0">Home</h1>
         <div class="muted" id="todayQuote">Keep going — small progress adds up.</div>
       </div>
       <div class="muted">Today: <span id="todayDate"></span></div>
    </div>
    <div style="margin-top:.8rem;display:flex;gap:1rem;flex-wrap:wrap">
      <div style="flex:1;min-width:220px">
        <div class="card">
            <h3 style="margin:.2rem 0">✨ Daily Motivation</h3>
            <div class="muted" id="quotesContainer" style="min-height: 40px;"> Your daily dose of motivation will appear here. </div>
            <button class="btn small" id="getMotivationBtn" style="margin-top: 0.5rem;"><i class="fas fa-magic"></i> Get Fresh Motivation</button>
        </div>
        
        <!-- NEW: Quick Navigation Bar -->
        <div class="card" style="padding: 0.75rem;">
            <h3 style="margin:.2rem 0 0.5rem">Quick Actions</h3>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: space-between;">
                <!-- This button navigates to the targets page -->
                <button class="btn small ghost" onclick="showSection('targetsSection', document.querySelector('.nav-item[data-target=\'targetsSection\']'))" style="flex: 1 1 120px; justify-content: center;">
                    <i class="fas fa-bullseye"></i>&nbsp;Manage Targets
                </button>
                <!-- This button opens the new Quick Task modal -->
                <button class="btn small ghost" onclick="$('quickTaskModal').style.display='block'" style="flex: 1 1 120px; justify-content: center;">
                    <i class="fas fa-bolt"></i>&nbsp;Quick Task
                </button>
                <!-- This button opens the existing API Key modal -->
                <button class="btn small ghost" onclick="$('apiKeyModal').style.display='block'" style="flex: 1 1 120px; justify-content: center;">
                    <i class="fas fa-key"></i>&nbsp;API Key
                </button>
                <!-- NEW: Log Learning Button -->
                <button class="btn small ghost" onclick="$('logLearningModal').style.display='block'" style="flex: 1 1 120px; justify-content: center;">
                    <i class="fas fa-lightbulb"></i>&nbsp;Log Learning
                </button>
            </div>
        </div>

      <div class="card" style="margin-top:1rem">
          <h3 style="margin:.2rem 0">Quick Stats</h3>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;flex-wrap:wrap">
            <div class="summary-card" style="min-width:120px">
              <div class="muted">Study (today)</div>
              <div id="todayStudyHours" style="font-weight:800;font-size:1.2rem">0 hrs</div>
            </div>
            <div class="summary-card" style="min-width:120px">
              <div class="muted">Workout (today)</div>
              <div id="todayWorkout" style="font-weight:800;font-size:1.2rem">0 min</div>
            </div>
            <div class="summary-card" style="min-width:120px">
                <div class="muted">Water (today)</div>
                <div id="todayWater" style="font-weight:800;font-size:1.2rem">0 L</div>
            </div>
            <div class="summary-card" style="min-width:120px">
                <div class="muted">Meditation</div>
                <div id="todayMeditation" style="font-weight:800;font-size:1.2rem">0 min</div>
            </div>
            <div class="summary-card" style="min-width:120px">
              <div class="muted">Tasks Done</div>
              <div id="todayCompletedTasks" style="font-weight:800;font-size:1.2rem">0</div>
            </div>
            <div class="summary-card" style="min-width:120px; grid-column: 1 / -1;">
              <div class="muted">Streak</div>
              <div id="streakCount" style="font-weight:800;font-size:1.2rem">0</div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <h3 style="margin:.2rem 0">Log Study</h3>
          <div class="muted">Study Hours (max per session: 12, per day: 24)</div>
          <!-- Added input for study topic -->
          <input id="studyTopic" type="text" placeholder="What did you study? (e.g., 'Calculus Chapter 3')" style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
          <!-- NEW: Link to Skill/Project -->
          <select id="studyLink" style="margin-bottom: 0.5rem;">
            <option value="">-- Link to Skill/Project (Optional) --</option>
            <!-- Options will be populated by JS -->
          </select>
          <div class="form-row">
            <input id="studyHours" type="number" min="0.1" max="12" step="0.1" placeholder="Hours (e.g., 1.5)">
            <select id="studyCategory"> <option value="College Study">College Study</option> <option value="Online Study">Online Study</option> <option value="Self Study">Self Study</option> <option value="Coding">Coding</option> </select>
            <button class="btn" onclick="logStudy()"><i class="fas fa-book"></i> Add</button>
          </div>
        </div>
        <div class="card" style="margin-top:1rem">
          <h3 style="margin:.2rem 0">Log Workout</h3>
          <div class="muted">Minutes of workout</div>
          <div class="form-row">
            <input id="workoutMins" type="number" min="1" step="1" placeholder="Minutes">
            <button class="btn" onclick="logWorkout()"><i class="fas fa-dumbbell"></i> Add</button>
          </div>
        </div>
        <div class="card" style="margin-top:1rem">
            <h3 style="margin:.2rem 0">Log Water Intake</h3>
            <div class="muted">Litres of water</div>
            <div class="form-row">
              <input id="waterLitres" type="number" min="0.1" step="0.1" placeholder="Litres (e.g., 2.5)">
              <button class="btn" onclick="logWater()"><i class="fas fa-tint"></i> Add</button>
            </div>
        </div>
        <div class="card" style="margin-top:1rem">
            <h3 style="margin:.2rem 0">Log Meditation</h3>
            <div class="muted">Minutes of meditation</div>
            <div class="form-row">
                <input id="meditationMins" type="number" min="1" step="1" placeholder="Minutes">
                <button class="btn" onclick="logMeditation()"><i class="fas fa-om"></i> Add</button>
            </div>
        </div>
        
        <!-- REMOVED: Old Log Learning Card -->
        <!-- This card's content is now in 'logLearningModal' -->
        
      </div>
      <div style="flex:1;min-width:300px">
        <div class="card">
          <h3 style="margin:.2rem 0">Sleep / Wake</h3>
          <div class="muted">Log sleep and wake-up times (stored per day)</div>
          <div class="form-row" style="align-items:center">
            <input id="sleepTime" type="time">
            <input id="wakeTime" type="time">
            <button class="btn" onclick="logSleep()"><i class="fas fa-bed"></i> Save</button>
          </div>
          <div style="margin-top:.6rem" id="sleepInfo"></div>
        </div>
        <div class="card" style="margin-top:1rem">
            <h3 style="margin:.2rem 0">Your Targets</h3>
            <div class="muted">Review and manage your weekly, monthly, and yearly goals.</div>
            <div class="form-row" style="margin-top: 1rem;">
                <button class="btn" onclick="showSection('targetsSection', null)" style="width: 100%; justify-content: center;">
                    <i class="fas fa-bullseye"></i>&nbsp;Manage Targets
                </button>
            </div>
        </div>
        <div class="card" style="margin-top:1rem">
            <h3 style="margin:.2rem 0">Today's Mood</h3>
            <div class="muted">Log how you're feeling today.</div>
            <div id="moodSelector" class="mood-selector">
                <div class="mood-option" onclick="logMood('terrible')" title="Terrible">😞</div>
                <div class="mood-option" onclick="logMood('bad')" title="Bad">😐</div>
                <div class="mood-option" onclick="logMood('okay')" title="Okay">🙂</div>
                <div class="mood-option" onclick="logMood('good')" title="Good">😊</div>
                <div class="mood-option" onclick="logMood('great')" title="Great">😄</div>
            </div>
            <div id="loggedMoodInfo" class="muted" style="text-align:center; margin-top:.5rem;"></div>
        </div>
        
      <div class="card" style="background: var(--accent); color: white;">
          <h3 style="margin:.2rem 0">✨ Gemini AI Features</h3>
          <div class="muted" style="color: rgba(255,255,255,0.8);">Unlock AI-powered motivation, task breakdown, and planning.</div>
          <button class="btn ghost" style="margin-top: 1rem; border-color: white; color: white; width: 100%; justify-content: center;" id="addApiKeyBtn">
            <i class="fas fa-key"></i>&nbsp;Manage API Key
          </button>
        </div>
    </div>
    </div>
  </section>

  <!-- Tasks -->
  <section id="tasksSection" class="section">
    <h2 style="margin:.2rem 0">Tasks</h2>
    <div class="muted">Organize your daily and weekly tasks.</div>
    
    <div class="tasks-layout" style="margin-top: 1rem;">
      <div class="card col">
        <h3 style="margin:.2rem 0">Active Tasks</h3>
        <div id="activeTasks" style="display:flex;flex-direction:column;gap:.6rem"></div>
      </div>
      <div class="card col">
        <h3 style="margin:.2rem 0">Completed Tasks</h3>
        <div id="completedTasks" style="display:flex;flex-direction:column;gap:.6rem"></div>
      </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab-add-task" onclick="$('addNewTaskModal').style.display='block'" title="Add New Task">
        <i class="fas fa-plus"></i>
    </button>
  </section>

  <!-- Dashboard -->
  <section id="dashboardSection" class="section">
    <h2 style="margin:.2rem 0">Dashboard</h2>
    <div class="filters">
      <button class="btn small" onclick="updateDashboard('weekly')">Weekly</button>
      <button class="btn small ghost" onclick="updateDashboard('monthly')">Monthly</button>
      <button class="btn small ghost" onclick="updateDashboard('yearly')">Yearly</button>
    </div>
    <div class="summary-cards" style="margin-top:1rem">
        <div class="summary-card"> <div class="muted">Study</div> <div id="selStudy" style="font-weight:800;font-size:1.2rem">0 hrs</div> </div>
        <div class="summary-card"> <div class="muted">Workout</div> <div id="selWorkout" style="font-weight:800;font-size:1.2rem">0 min</div> </div>
        <div class="summary-card"> <div class="muted">Meditation</div> <div id="selMeditation" style="font-weight:800;font-size:1.2rem">0 min</div> </div>
        <div class="summary-card"> <div class="muted">Tasks Done</div> <div id="selTasks" style="font-weight:800;font-size:1.2rem">0</div> </div>
        <div class="summary-card" style="grid-column: 1 / -1;"> <div class="muted">Current Streak</div> <div id="selStreak" style="font-weight:800;font-size:1.2rem">0</div> </div>
    </div>
    <div class="analytics-grid" style="margin-top:1rem">
        <div class="chart-wrap"> <h4 style="margin:.2rem 0">Study Trend (hrs)</h4> <canvas id="chartStudy" height="140"></canvas> </div>
        <div class="chart-wrap"> <h4 style="margin:.2rem 0">Workout Trend (mins)</h4> <canvas id="chartWorkout" height="140"></canvas> </div>
        <div class="chart-wrap"> <h4 style="margin:.2rem 0">Meditation Trend (mins)</h4> <canvas id="chartMeditation" height="140"></canvas> </div>
        <div class="chart-wrap"> <h4 style="margin:.2rem 0">Tasks Completed</h4> <canvas id="chartTasks" height="140"></canvas> </div>
    </div>
  </section>

  <!-- Analytics -->
  <section id="analyticsSection" class="section">
    <h2 style="margin:.2rem 0">Analytics</h2>
    <div class="filters">
      <button class="btn small" onclick="updateAnalytics('weekly')">Weekly</button>
      <button class="btn small ghost" onclick="updateAnalytics('monthly')">Monthly</button>
      <button class="btn small ghost" onclick="updateAnalytics('yearly')">Yearly</button>
    </div>
    <div class="analytics-grid" style="margin-top:1rem">
      <div class="chart-wrap"> <h4 style="margin:.2rem 0">Study by Category</h4> <canvas id="chartStudyByCat" height="140"></canvas> </div>
      <div class="chart-wrap"> <h4 style="margin:.2rem 0">Task Completion Trend</h4> <canvas id="chartTaskTrend" height="140"></canvas> </div>
      <div class="chart-wrap"> <h4 style="margin:.2rem 0">Sleep Patterns (Sleep vs Wake hour)</h4> <canvas id="chartSleep" height="140"></canvas> </div>
      <div class="chart-wrap"> <h4 style="margin:.2rem 0">Workout Distribution</h4> <canvas id="chartWorkoutDist" height="140"></canvas> </div>
      <!-- NEW: Study by Skill Chart -->
      <div class="chart-wrap"> <h4 style="margin:.2rem 0">Study Hours by Skill/Project</h4> <canvas id="chartStudyBySkill" height="140"></canvas> </div>
      <div class="chart-wrap"> <h4 style="margin:.2rem 0">Mood & Productivity Correlation</h4> <canvas id="chartMood" height="140"></canvas> </div>
      <div class="chart-wrap"> <h4 style="margin:.2rem 0">Water Intake (Litres)</h4> <canvas id="chartWater" height="140"></canvas> </div>
    </div>
  </section>

  <!-- Targets Section -->
  <section id="targetsSection" class="section">
        <h2 style="margin:.2rem 0">Targets & Goals</h2>
        <div class="muted">Set your weekly, monthly, and yearly goals to stay on track.</div>
        
        <div class="tasks-layout" style="margin-top: 1rem;">
            <!-- Weekly Targets -->
            <div class="card">
                <h3 style="margin:.2rem 0">Weekly Targets</h3>
                <div class="muted">What do you want to achieve this week?</div>
                <div class="form-row" style="margin-top: 1rem;">
                    <input id="newWeeklyTarget" placeholder="e.g., Finish math assignment">
                    <button class="btn" onclick="addTarget('week')"><i class="fas fa-plus"></i> Add</button>
                </div>
                <div id="weeklyTargetsList" style="margin-top: 1rem; display: flex; flex-direction: column; gap: .6rem;"></div>
            </div>

            <!-- Monthly Targets -->
            <div class="card">
                <h3 style="margin:.2rem 0">Monthly Targets</h3>
                <div class="muted">What are your goals for this month?</div>
                <div class="form-row" style="margin-top: 1rem;">
                    <input id="newMonthlyTarget" placeholder="e.g., Read 2 books">
                    <button class="btn" onclick="addTarget('month')"><i class="fas fa-plus"></i> Add</button>
                </div>
                <div id="monthlyTargetsList" style="margin-top: 1rem; display: flex; flex-direction: column; gap: .6rem;"></div>
            </div>
            
            <!-- Yearly Targets -->
            <div class="card">
                <h3 style="margin:.2rem 0">Yearly Targets</h3>
                <div class="muted">What are your big goals for this year?</div>
                <div class="form-row" style="margin-top: 1rem;">
                    <input id="newYearlyTarget" placeholder="e.g., Get an internship">
                    <button class="btn" onclick="addTarget('year')"><i class="fas fa-plus"></i> Add</button>
                </div>
                <div id="yearlyTargetsList" style="margin-top: 1rem; display: flex; flex-direction: column; gap: .6rem;"></div>
            </div>

            <!-- NEW: Manage Skills Card -->
            <div class="card">
                <h3 style="margin:.2rem 0">Manage Skills</h3>
                <div class="muted">Define skills you want to track.</div>
                <div class="form-row" style="margin-top: 1rem;">
                    <input id="newSkillName" placeholder="e.g., Python, System Design">
                    <button class="btn" onclick="addSkill()"><i class="fas fa-plus"></i> Add</button>
                </div>
                <div id="skillsList" style="margin-top: 1rem; display: flex; flex-direction: column; gap: .5rem;">
                    <!-- Skills will be loaded here -->
                </div>
            </div>

            <!-- NEW: Manage Projects Card -->
            <div class="card">
                <h3 style="margin:.2rem 0">Manage Projects</h3>
                <div class="muted">Define projects you are working on.</div>
                <div class="form-row" style="margin-top: 1rem;">
                    <input id="newProjectName" placeholder="e.g., Portfolio Website, AI-ML-Paper-Implementation">
                    <button class="btn" onclick="addProject()"><i class="fas fa-plus"></i> Add</button>
                </div>
                <div id="projectsList" style="margin-top: 1rem; display: flex; flex-direction: column; gap: .5rem;">
                    <!-- Projects will be loaded here -->
                </div>
            </div>

        </div>
    </section>

  <!-- NEW: Learnings Journal Section -->
  <section id="learningsSection" class="section">
    <h2 style="margin:.2rem 0">Wins & Learnings Journal</h2>
    <div class="muted">Your personal, searchable knowledge base.</div>
    
    <!-- Filter/Search Card -->
    <div class="card" style="margin-top: 1rem;">
        <h3 style="margin:.2rem 0">Filter Entries</h3>
        <input id="learningSearchInput" type="text" oninput="loadLearnings()" placeholder="Search by keyword..." style="margin-top: 0.5rem; width: 100%;">
        <div class="muted" style="margin-top: 1rem; margin-bottom: 0.5rem;">Filter by Tag:</div>
        <div id="learningTagFilters" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
            <!-- Clickable tags will be populated here -->
        </div>
    </div>

    <!-- Entries List -->
    <div class="card" style="margin-top: 1rem;">
        <h3 style="margin:.2rem 0">All Entries</h3>
        <div id="learningsList" style="display:flex;flex-direction:column;gap:.75rem; margin-top: 1rem;">
            <!-- Learnings will be loaded here -->
        </div>
    </div>
  </section>

  <!-- Profile Section -->
  <section id="profileSection" class="section">
    <div class="card">
        <h2 style="margin:.2rem 0">Personal Details</h2>
        <div class="muted">Providing these details helps the AI give you more personalized advice. This information is stored only on your device.</div>
        <div style="margin-top: 1rem; display: flex; flex-direction: column; gap: 1rem;">
            <div>
                <label for="userName" class="muted" style="margin-bottom: .25rem; display: block;">Your Name</label>
                <input id="userName" type="text" placeholder="e.g., Alex Doe">
            </div>
            <div>
                <label for="userAge" class="muted" style="margin-bottom: .25rem; display: block;">Your Age</label>
                <input id="userAge" type="number" min="1" placeholder="e.g., 25">
            </div>
            <div>
                <label for="userEducation" class="muted" style="margin-bottom: .25rem; display: block;">Highest Education</label>
                <select id="userEducation">
                    <option value="">Select...</option>
                    <option value="High School">High School</option>
                    <option value="Bachelor's Degree">Bachelor's Degree</option>
                    <option value="Master's Degree">Master's Degree</option>
                    <option value="PhD">PhD</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div>
                <label for="userGoal" class="muted" style="margin-bottom: .25rem; display: block;">Your Primary Goal</label>
                <textarea id="userGoal" rows="3" placeholder="e.g., I'm a student preparing for final exams in computer science."></textarea>
            </div>
            <button class="btn" onclick="saveProfileDetails()" style="justify-content: center;"><i class="fas fa-save"></i>&nbsp;Save Details</button>
        </div>
    </div>
  </section>

  <!-- AI Chat -->
  <section id="chatSection" class="section">
    <h2 style="margin:.2rem 0">AI Chat</h2>
    <div class="card" style="margin-top: 1rem; padding: 0.5rem; display: flex; flex-direction: column; height: 70vh;">
        <!-- Chat Messages -->
        <div id="chatMessages" style="flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.75rem;">
            <!-- Messages render here -->
        </div>
        
        <!-- Suggestions -->
        <div id="chatSuggestions" style="padding: 0.5rem 1rem; border-top: 1px solid rgba(0,0,0,0.05); display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn small ghost" onclick="useSuggestion('How am I doing this week?')">How am I doing?</button>
            <button class="btn small ghost" onclick="useSuggestion('Suggest a study plan for today.')">Suggest study plan</button>
            <button class="btn small ghost" onclick="useSuggestion('What should I focus on?')">What to focus on?</button>
        </div>
        
        <!-- Input Area -->
        <div class="form-row" style="padding: 1rem; border-top: 1px solid rgba(0,0,0,0.05); margin-top: 0;">
            <input id="chatInput" placeholder="Ask for advice or a plan...">
            <button class="btn" id="sendChatBtn" style="flex: 0 1 auto;"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
  </section>

</div>

<div id="toast" class="toast"></div>

<!-- AI Modal -->
<div id="aiModal" class="modal">
  <div class="modal-content">
    <span id="closeModal" class="close-modal">&times;</span>
    <h3 id="modalTitle">Suggested Sub-tasks</h3>
    <div id="modalContent" style="max-height: 40vh; overflow-y: auto;"></div>
     <button class="btn" id="modalActionBtn" style="margin-top: 1rem;">Close</button>
  </div>
</div>

<!-- API Key Modal -->
<div id="apiKeyModal" class="modal">
  <div class="modal-content">
    <span id="closeApiKeyModal" class="close-modal">&times;</span>
    <h3 style="margin:.2rem 0">Set Your Gemini API Key</h3>
    <div class="muted">To enable AI features, please provide your API key. You can get one from Google AI Studio.</div>
    <input id="apiKeyInput" type="password" placeholder="Enter your API key here" style="margin-top: 1rem;">
    <div class="form-row" style="margin-top: 1rem; justify-content: space-between;">
        <button class="btn ghost" id="removeApiKeyBtn" style="flex: 1; justify-content: center;"><i class="fas fa-trash"></i> Remove Key</button>
        <button class="btn" id="saveApiKeyBtn" style="flex: 2; justify-content: center;"><i class="fas fa-save"></i> Save Key</button>
    </div>
  </div>
</div>

<!-- Quick Task Modal -->
<div id="quickTaskModal" class="modal">
  <div class="modal-content">
    <span id="closeQuickTaskModal" class="close-modal">&times;</span>
    <h3 style="margin:.2rem 0">Quick Task</h3>
    <div class="muted">Add quick task with time/duration</div>
    <div style="display:flex;flex-direction:column;gap:.5rem;margin-top:.5rem">
        <input id="quickTaskTitle" placeholder="Title">
        <div class="form-row">
            <input id="quickTaskTime" type="time">
            <input id="quickTaskDuration" type="number" min="1" placeholder="Duration (mins)">
            <button class="btn" onclick="addQuickTask()"><i class="fas fa-bolt"></i> Add</button>
        </div>
    </div>
  </div>
</div>

<!-- Add Task Modal -->
<div id="addNewTaskModal" class="modal">
  <div class="modal-content">
    <span id="closeNewTaskModal" class="close-modal">&times;</span>
    <h3 style="margin:.2rem 0">Add New Task</h3>
    <div class="muted">Add a new task to your list.</div>
    <div style="display:flex;flex-direction:column;gap:.75rem;margin-top:1rem;">
        <input id="newTaskTitle" placeholder="Task title">
        <input id="newTaskDesc" placeholder="Description">
        <div class="form-row" style="gap: 1rem;">
            <select id="taskPriority" style="flex: 1 1 100px;"> <option value="low">Low</option> <option value="medium">Medium</option> <option value="high">High</option> </select>
            <select id="taskCategory" style="flex: 1 1 100px;"> <option value="personal">Personal</option> <option value="work">Work</option> <option value="study">Study</option> <option value="health">Health</option> </select>
        </div>
        <div class="form-row" style="gap: 1rem;">
            <input id="taskStartTime" type="time" title="Start" style="flex: 1 1 100px;">
            <input id="taskEndTime" type="time" title="End" style="flex: 1 1 100px;">
        </div>
        <div class="form-row" style="margin-top: 1rem;">
            <button class="btn" onclick="addNewTask()" style="flex: 2; justify-content: center;"><i class="fas fa-plus"></i> Add Task</button>
            <button class="btn ghost" id="breakdownBtn" style="flex: 1; justify-content: center;"><i class="fas fa-cogs"></i> ✨ Break Down</button>
        </div>
    </div>
  </div>
</div>

<!-- NEW: Weekly Review Prompt Modal -->
<div id="weeklyReviewPromptModal" class="modal">
  <div class="modal-content" style="max-width: 450px; text-align: center;">
    <span id="closeWeeklyReviewModal" class="close-modal">&times;</span>
    <i class="fas fa-calendar-check" style="font-size: 3rem; color: var(--accent); margin-bottom: 1rem;"></i>
    <h3 style="margin:.2rem 0">It's Weekly Review Time!</h3>
    <div class="muted" style="margin: 0.5rem 0 1.5rem;">Ready for your 10-minute review with the AI Coach?</div>
    <div class="form-row" style="gap: 1rem; justify-content: center;">
        <button class="btn ghost" id="skipWeeklyReviewBtn" style="flex: 1;">Maybe Later</button>
        <button class="btn" id="startWeeklyReviewBtn" style="flex: 2;">Start Review</button>
    </div>
  </div>
</div>

<!-- NEW: Log Learning Modal -->
<div id="logLearningModal" class="modal">
  <div class="modal-content">
    <span id="closeLogLearningModal" class="close-modal">&times;</span>
    <h3 style="margin:.2rem 0">Log a Win or Learning</h3>
    <div class="muted">Log an insight, bug solution, or idea.</div>
    <!-- Content moved from the old homepage card -->
    <div style="display:flex;flex-direction:column;gap:.75rem;margin-top:1rem;">
        <textarea id="modalLearningText" rows="3" placeholder="e.g., Solved the async bug by using Promise.all()..." style="margin-top: 0.5rem;"></textarea>
        <input id="modalLearningTags" type="text" placeholder="Tags (e.g., #bug, #interview-story, #python)" style="margin-top: 0.5rem;">
        <button class="btn" onclick="logLearning()" style="margin-top: 0.5rem; width: 100%; justify-content: center;"><i class="fas fa-lightbulb"></i> Log Entry</button>
    </div>
  </div>
</div>

<nav class="bottom-nav" aria-hidden="false">
  <div class="bottom-nav-inner" role="navigation">
    <div class="nav-item active" data-target="homeSection" onclick="showSection('homeSection', this)"><i class="fas fa-home"></i><span class="nav-text">Home</span></div>
    <div class="nav-item" data-target="tasksSection" onclick="showSection('tasksSection', this)"><i class="fas fa-tasks"></i><span class="nav-text">Tasks</span></div>
    <div class="nav-item" data-target="dashboardSection" onclick="showSection('dashboardSection', this)"><i class="fas fa-chart-line"></i><span class="nav-text">Dashboard</span></div>
    <div class="nav-item" data-target="targetsSection" onclick="showSection('targetsSection', this)"><i class="fas fa-bullseye"></i><span class="nav-text">Targets</span></div>
    <div class="nav-item" data-target="analyticsSection" onclick="showSection('analyticsSection', this)"><i class="fas fa-chart-pie"></i><span class="nav-text">Analytics</span></div>
    <div class="nav-item" data-target="learningsSection" onclick="showSection('learningsSection', this)"><i class="fas fa-book-reader"></i><span class="nav-text">Learnings</span></div>
    <div class="nav-item" data-target="profileSection" onclick="showSection('profileSection', this)"><i class="fas fa-user-circle"></i><span class="nav-text">Profile</span></div>
    <div class="nav-item" data-target="chatSection" onclick="showSection('chatSection', this)"><i class="fas fa-comments"></i><span class="nav-text">AI Chat</span></div>
  </div>
</nav>

<script>
/*
  Productivity Tracker - single file app
  - Features: Study, Workout, Task, Sleep, Mood, Water logging, Target Setting, Profile
  - Added Gemini AI for task breakdown, motivation, and chat-based planning
*/

const STORAGE_PREFIX = 'prodtrk_';
const MAX_DAILY_STUDY = 24;
const MAX_SESSION_STUDY = 12;
const MOOD_MAP = { 'terrible': 1, 'bad': 2, 'okay': 3, 'good': 4, 'great': 5 };

let charts = {};
let currentDashboardRange = 'weekly';
let currentAnalyticsRange = 'weekly';
let notificationInterval = null;
let chatHistory = [];

// NOTE: The API key is handled by the user input field on the page.
// The callGemini function will use the key saved in local storage.
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent';

function $(id){ return document.getElementById(id); }

function showSection(id, el){
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  $(id).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if(el) el.classList.add('active');
  if(id==='dashboardSection') updateDashboard(currentDashboardRange);
  if(id==='analyticsSection') updateAnalytics(currentAnalyticsRange);
  if(id==='homeSection') loadHomeQuickStats();
  if(id==='tasksSection') loadTasks();
  if(id==='targetsSection') { loadTargets(); loadSkillsAndProjects(); } // <-- Modified
  if(id==='learningsSection') loadLearnings(true); // <-- NEW
  if(id==='profileSection') loadProfileDetails();
}

/* ====== Helper: Date keys & ranges ====== */
function todayISO(){ 
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}
function datePlusDays(baseDateISO, offset){
  const d = new Date(baseDateISO + 'T00:00:00');
  d.setDate(d.getDate()+offset);
  return d.toISOString().split('T')[0];
}
function formatDateLabel(iso){ const d=new Date(iso); return `${d.getMonth()+1}/${d.getDate()}`; }
function getRangeDays(range){
  const today = new Date();
  let days = [];
  if(range==='weekly'){ for(let i=6;i>=0;i--) days.push(datePlusDays(todayISO(), -i)); } 
  else if(range==='monthly'){ const d = new Date(); const daysInMonth = new Date(d.getFullYear(), d.getMonth()+1, 0).getDate(); for(let i=daysInMonth-1;i>=0;i--) days.push(datePlusDays(d.toISOString().split('T')[0], -i)); } 
  else { for(let m=0;m<12;m++){ const d = new Date(); d.setMonth(m); d.setDate(1); days.push(d.toISOString().slice(0,7)); } }
  return days;
}

/* ====== LocalStorage helpers ====== */
function read(key, fallback=null){ try{ const v = localStorage.getItem(STORAGE_PREFIX + key); return v ? JSON.parse(v) : fallback; } catch(e){ return fallback; } }
function write(key, val){ localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(val)); }

/* ====== Toast ====== */
let toastTimer=null;
function showToast(msg, timeout=2200){
  const t = $('toast');
  t.textContent = msg;
  t.style.display='block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> t.style.display='none', timeout);
}

/* ====== Gemini API Integration ====== */
function getApiKey(){ return read('gemini_api_key'); }
function saveApiKey(){ 
    const key = $('apiKeyInput').value.trim(); 
    if (key) { 
        write('gemini_api_key', key); 
        showToast('API Key saved!'); 
        $('apiKeyModal').style.display = 'none';
    } else { 
        showToast('Please enter a valid API Key.'); 
    } 
}
function removeApiKey() {
    localStorage.removeItem(STORAGE_PREFIX + 'gemini_api_key');
    $('apiKeyInput').value = '';
    showToast('API Key removed.');
    $('apiKeyModal').style.display = 'none';
}

async function callGemini(prompt, buttonElement = null, retries = 3, delay = 1000) {
    const apiKey = getApiKey();
    if (!apiKey) {
        showToast('Please enter and save your Gemini API Key in the Home section.');
        // You might want to navigate the user to the home section automatically
        // showSection('homeSection', document.querySelector('.nav-item[data-target="homeSection"]'));
        return null;
    }

    const originalButtonHTML = buttonElement ? buttonElement.innerHTML : '';
    if (buttonElement) { buttonElement.disabled = true; buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; }
    
    const payload = { contents: [{ parts: [{ text: prompt }] }], };
    
    for (let i = 0; i < retries; i++) {
        try {
            const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { const error = await response.json(); throw new Error(error.error ? error.error.message : `HTTP error! status: ${response.status}`); }
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text || null;
        } catch (error) {
            console.error('Gemini API call failed:', error);
            if (i === retries - 1) { showToast(`AI request failed. Check console for details.`); return null; }
            await new Promise(res => setTimeout(res, delay * Math.pow(2, i)));
        } finally {
            if (buttonElement) { buttonElement.disabled = false; buttonElement.innerHTML = originalButtonHTML; }
        }
    }
    return null;
}


async function getDailyMotivation() {
    const study = totalStudyForDay(todayISO());
    const workout = totalWorkoutForDay(todayISO());
    const today = todayISO();
    const tasks = getTasks().filter(t => t.completed && t.completedAt && t.completedAt.startsWith(today)).length;
    const streak = read('streak', 0);

    let contextParts = [];
    if (study > 0) contextParts.push(`studied for ${study.toFixed(1)} hours`);
    if (workout > 0) contextParts.push(`worked out for ${workout} minutes`);
    if (tasks > 0) contextParts.push(`completed ${tasks} ${tasks > 1 ? 'tasks' : 'task'}`);

    let context;
    if (contextParts.length > 0) {
        context = `The user has ${contextParts.join(' and ')} today.`;
    } else {
        context = "The user hasn't logged any activity yet today.";
    }

    if (streak > 1) {
        context += ` They are currently on a ${streak}-day streak!`;
    }

    const prompt = `You are an encouraging productivity coach. Write a short, fresh, and powerful motivational quote for a user. Be inspiring and concise (1-2 sentences). Current user context: ${context}`;
    const responseText = await callGemini(prompt, $('getMotivationBtn'));
    if (responseText) { $('quotesContainer').textContent = responseText; }
}

async function breakDownTask() {
    const mainTaskTitle = $('newTaskTitle').value.trim();
    if (!mainTaskTitle) { showToast('Please enter a task title to break down.'); return; }
    const prompt = `You are a productivity assistant. Break down the following task into a list of smaller, actionable sub-tasks. Return the response as a valid JSON array of strings. Do not include any other text, code formatting, or explanations, just the raw JSON array. Task: "${mainTaskTitle}"`;
    const responseText = await callGemini(prompt, $('breakdownBtn'));
    if (!responseText) return;
    try {
        const cleanedResponse = responseText.replace(/```json/g, '').replace(/```/g, '').trim();
        let subTasks = JSON.parse(cleanedResponse);
        if (!Array.isArray(subTasks)) throw new Error("Response is not an array.");
        const modalContent = $('modalContent');
        modalContent.innerHTML = '';
        if (subTasks.length === 0) { modalContent.innerHTML = '<p class="muted">AI could not break down this task further.</p>'; } 
        else {
            subTasks.forEach(taskText => {
                const item = document.createElement('div');
                item.className = 'subtask-item';
                const text = document.createElement('span');
                text.textContent = taskText;
                item.appendChild(text);
                const addButton = document.createElement('button');
                addButton.className = 'btn small';
                addButton.innerHTML = '<i class="fas fa-plus"></i> Add';
                addButton.onclick = () => {
                    const tasks = getTasks();
                    tasks.push({ id: Date.now() + Math.floor(Math.random() * 999), title: taskText, description: `Sub-task of '${mainTaskTitle}'`, priority: 'low', category: 'personal', startTime: '', endTime: '', completed: false, createdAt: new Date().toISOString() });
                    saveTasks(tasks);
                    showToast(`Sub-task added.`);
                    loadTasks();
                    item.remove();
                };
                item.appendChild(addButton);
                modalContent.appendChild(item);
            });
        }
        $('modalTitle').textContent = `Sub-tasks for "${mainTaskTitle}"`;
        $('modalActionBtn').onclick = () => $('aiModal').style.display = 'none';
        $('aiModal').style.display = 'block';
    } catch (e) {
        console.error("Failed to parse AI response:", e, "Raw response:", responseText);
        showToast("AI returned an invalid format. Please try again.");
        $('modalContent').innerHTML = `<p class="muted">The AI response was not in the expected format. Here is the raw response:</p><pre style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(responseText)}</pre>`;
        $('modalTitle').textContent = `Response Error`;
        $('modalActionBtn').onclick = () => $('aiModal').style.display = 'none';
        $('aiModal').style.display = 'block';
    }
}

/* ====== AI Chat Functions ====== */

function getAIContext() {
    const profile = getProfileDetails();
    let context = "User's Profile:\n";
    if (profile.name || profile.age || profile.education || profile.goal) {
        if (profile.name) context += `- Name: ${profile.name}\n`;
        if (profile.age) context += `- Age: ${profile.age}\n`;
        if (profile.education) context += `- Education: ${profile.education}\n`;
        if (profile.goal) context += `- Primary Goal: "${profile.goal}"\n`;
    } else {
        context += '- No personal details provided.\n';
    }

    context += "\nUser's Productivity Summary (Last 7 Days):\n";
    let totalStudy = 0, totalWorkout = 0, tasksCompleted = 0, moodSum = 0, moodCount = 0, totalWater = 0, totalMeditation = 0;
    let recentStudyTopics = []; // <-- Add
    
    // NEW: Skill/Project Tracking
    const skillsMap = getSkills().reduce((acc, s) => ({ ...acc, [`skill:${s.id}`]: s.name }), {});
    const projectsMap = getProjects().reduce((acc, p) => ({ ...acc, [`project:${p.id}`]: p.name }), {});
    const linkMap = { ...skillsMap, ...projectsMap };
    let linkedTime = {};
    
    // NEW: Get recent learnings
    const oneWeekAgo = new Date(datePlusDays(todayISO(), -7)).getTime();
    const recentLearnings = getLearnings()
        .filter(l => new Date(l.createdAt).getTime() >= oneWeekAgo)
        .map(l => l.text.substring(0, 100) + (l.text.length > 100 ? '...' : '')); // Get first 100 chars
    
    for (let i = 0; i < 7; i++) {
        const day = datePlusDays(todayISO(), -i);

        const studyEntries = getStudyForDay(day); // <-- Get entries
        studyEntries.forEach(e => { // <-- Loop
            const hours = (parseFloat(e.hours) || 0);
            totalStudy += hours;
            if (e.topic) recentStudyTopics.push(e.topic);
            // NEW: Track linked time
            if (e.linkedItem && linkMap[e.linkedItem]) {
                const name = linkMap[e.linkedItem];
                linkedTime[name] = (linkedTime[name] || 0) + hours;
            }
        });
        // totalStudy += totalStudyForDay(day); // <-- Replace this
        
        totalWorkout += totalWorkoutForDay(day);
        totalMeditation += totalMeditationForDay(day);
        tasksCompleted += getTasks().filter(t => t.completed && t.completedAt && t.completedAt.startsWith(day)).length;
        const mood = getMoodForDay(day);
        if (mood) {
            moodSum += MOOD_MAP[mood.mood] || 0;
            moodCount++;
        }
        totalWater += totalWaterForDay(day);
    }
    const activeTasks = getTasks().filter(t => !t.completed).length;
    const streak = read('streak', 0);
    const weeklyTargets = getTargets().filter(t => t.period === 'week' && !t.completed && isDateInCurrentWeek(t.createdAt)).map(t => t.text);

    context += `- Total Study: ${totalStudy.toFixed(1)} hours\n`;
    if (recentStudyTopics.length > 0) {
        const uniqueTopics = [...new Set(recentStudyTopics)]; // Get unique topics
        context += `- Recent Study Topics: ${uniqueTopics.slice(0, 5).join(', ')}${uniqueTopics.length > 5 ? '...' : ''}\n`; // Show top 5
    }
    // NEW: Add linked time to context
    if (Object.keys(linkedTime).length > 0) {
        context += `- Time by Skill/Project:\n`;
        for (const key in linkedTime) {
            context += `  - ${key}: ${linkedTime[key].toFixed(1)} hours\n`;
        }
    }
    // NEW: Add recent learnings to context
    if (recentLearnings.length > 0) {
        context += `- Recent Wins/Learnings (${recentLearnings.length}):\n`;
        recentLearnings.slice(0, 3).forEach(l_text => { // Show max 3
            context += `  - "${l_text}"\n`;
        });
    }
    context += `- Total Workout: ${totalWorkout} minutes\n`;
    context += `- Total Meditation: ${totalMeditation} minutes\n`;
    context += `- Total Water Intake: ${totalWater.toFixed(1)} litres\n`;
    context += `- Tasks Completed: ${tasksCompleted}\n`;
    context += `- Pending Tasks: ${activeTasks}\n`;
    context += `- Current Streak: ${streak} days\n`;
    if (moodCount > 0) {
        const avgMoodNum = (moodSum / moodCount);
        const moodNumToText = { 1: 'terrible', 2: 'bad', 3: 'okay', 4: 'good', 5: 'great' };
        context += `- Average Mood: ${moodNumToText[Math.round(avgMoodNum)]} (${avgMoodNum.toFixed(1)}/5.0)\n`;
    }
    if (weeklyTargets.length > 0) {
        context += `- Active Weekly Targets: ${weeklyTargets.join(', ')}\n`;
    } else {
        context += "- No active weekly targets.\n";
    }
    return context;
}

function parseMarkdown(text) {
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
    text = text.replace(/^\s*[\*-]\s+(.*)$/gm, '<li>$1</li>');
    text = text.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
    text = text.replace(/\n/g, '<br>').replace(/<ul><br>/g, '<ul>').replace(/<br><\/ul>/g, '</ul>').replace(/<\/li><br>/g, '</li>');
    return text;
}

function renderChat() {
    const chatMessages = $('chatMessages');
    chatMessages.innerHTML = '';
    if (chatHistory.length === 0) {
         const welcomeDiv = document.createElement('div');
         welcomeDiv.className = 'chat-message chat-ai';
         welcomeDiv.innerHTML = "Hello! I'm Gemini. How can I help you plan your week or month? You can ask for a study plan, a workout routine, or anything else you need to organize.";
         chatMessages.appendChild(welcomeDiv);
    }
    chatHistory.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-message ${msg.role === 'user' ? 'chat-user' : 'chat-ai'}`;
        if(msg.typing) { messageDiv.innerHTML = `<div class="typing-indicator"><span></span><span></span><span></span></div>`; } 
        else { messageDiv.innerHTML = parseMarkdown(escapeHtml(msg.text)); }
        chatMessages.appendChild(messageDiv);
    });
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function handleSendMessage() {
    const input = $('chatInput');
    const message = input.value.trim();
    if (!message) return;
    chatHistory.push({ role: 'user', text: message });
    chatHistory.push({ role: 'ai', typing: true });
    renderChat();
    input.value = '';
    const today = new Date();
    const context = getAIContext();
    const prompt = `You are a helpful and motivating productivity assistant named Gemini. Your role is to analyze the user's data and provide actionable advice.
---
${context}
---
Current time: ${today.toLocaleTimeString('en-US')} on ${today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}.
Based on the detailed data provided, respond to the user's request below.
Act as a smart productivity assistant for students. Analyze user tasks and give focused, motivating, and actionable responses.”

Guidelines:

✅ Summarize tasks clearly and highlight top 3 priorities.

⏰ Suggest optimal time allocation based on urgency and workload.

💡 Provide one short motivational line related to progress or focus.

📅 Recommend realistic next steps for today.

📊 Encourage consistency, not perfection — avoid overloading the user.

🧘 Keep tone friendly, encouraging, and student-focused

User's request: "${message}"`;
    const responseText = await callGemini(prompt, $('sendChatBtn'));
    chatHistory.pop();
    if (responseText) { chatHistory.push({ role: 'ai', text: responseText }); } 
    else { chatHistory.push({ role: 'ai', text: "Sorry, I couldn't process that request. Please try again." }); }
    renderChat();
    saveChatHistory();
}

function useSuggestion(text) { $('chatInput').value = text; handleSendMessage(); }
function loadChatHistory() { chatHistory = read('chat_history', []); renderChat(); }
function saveChatHistory() { write('chat_history', chatHistory); }

/* ====== NOTIFICATION SYSTEM ====== */
function checkTaskReminders() {
    if (Notification.permission !== 'granted') return;
    const now = new Date();
    const tasks = getTasks().filter(t => !t.completed && t.startTime && !t.notified);
    tasks.forEach(task => {
        const [hours, minutes] = task.startTime.split(':').map(Number);
        const taskTime = new Date(); 
        taskTime.setHours(hours, minutes, 0, 0);
        const diffMinutes = (taskTime.getTime() - now.getTime()) / 1000 / 60;
        if (diffMinutes <= 5 && diffMinutes > -2) {
            new Notification('Upcoming Task Reminder', { body: `'${task.title}' is scheduled for ${task.startTime}.`, icon: 'https://placehold.co/96x96/2b7cff/ffffff?text=PT' });
            markTaskAsNotified(task.id);
        }
    });
}
function markTaskAsNotified(id) {
    let tasks = getTasks();
    const taskIndex = tasks.findIndex(t => t.id === id);
    if (taskIndex !== -1) { tasks[taskIndex].notified = true; saveTasks(tasks); }
}
function setupNotificationButton() {
    const btn = $('notificationBtn');
    if (!("Notification" in window)) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-bell-slash"></i> Not Supported'; return; }
    const updateButtonState = () => {
        if (Notification.permission === 'granted') { btn.innerHTML = '<i class="fas fa-bell"></i> Reminders On'; btn.classList.add('active'); btn.disabled = true; } 
        else if (Notification.permission === 'denied') { btn.innerHTML = '<i class="fas fa-bell-slash"></i> Blocked'; btn.disabled = true; } 
        else { btn.innerHTML = '<i class="fas fa-bell"></i> Enable Reminders'; btn.classList.remove('active'); }
    };
    btn.addEventListener('click', () => {
        if (Notification.permission !== 'granted' && Notification.permission !== 'denied') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    showToast('Task reminders are now enabled!');
                    checkTaskReminders();
                    notificationInterval = setInterval(checkTaskReminders, 60000);
                } else { showToast('Reminders permission denied.'); }
                updateButtonState();
            });
        }
    });
    updateButtonState();
    if (Notification.permission === 'granted') { if (notificationInterval) clearInterval(notificationInterval); notificationInterval = setInterval(checkTaskReminders, 60000); }
}

/* ====== Quotes (daily rotate) ====== */
const QUOTES = [ "Small steps every day lead to big gains.", 
"Focus on progress, not perfection.", 
"Your future is created by what you do today.",
 "Consistency beats intensity over time.", 
 "Do something today your future self will thank you for.",
"Discipline turns dreams into daily habits.",
"One focused hour can change your entire day.",
"Success is built quietly, one step at a time.",
"Even small wins count — keep moving forward.",
"Show up today; tomorrow will thank you for it.",
"Progress happens when excuses stop.",
"Every day you delay, someone else improves — start now.",
"Momentum is built, not found — stay consistent.",
"You don’t need motivation, just start — action creates it.",
"Tiny progress each day adds up to massive change.",
"One task done is better than ten planned.",
"Small focus today builds big results tomorrow.",
"Don’t chase speed — chase consistency.",
"The hardest step is the first — take it now.",
"Your routine shapes your results.",
"Keep showing up, even when it’s boring.",
"Effort compounds faster than motivation.",
"Do what you can, with what you have, today.",
"Progress isn’t loud — it’s steady.",
"Start simple, stay steady, grow strong.", ];
 
function setDailyQuote(){ 
    // Select a random quote from the array on each page load
    const idx = Math.floor(Math.random() * QUOTES.length);
    $('todayQuote').textContent = QUOTES[idx]; 
}

/* ====== Data Logging Functions (Study, Workout, Sleep, Tasks, Mood, Water, Meditation) ====== */
function getStudyForDay(dayISO){ return read('study_' + dayISO, []); }
function saveStudyForDay(dayISO, arr){ write('study_' + dayISO, arr); }
function totalStudyForDay(dayISO){ return getStudyForDay(dayISO).reduce((s,x)=>s+(parseFloat(x.hours)||0),0); }
function logStudy(){
  const hoursInput = parseFloat($('studyHours').value || 0);
  const category = $('studyCategory').value;
  const topic = $('studyTopic').value.trim(); // <-- Get topic
  const linkedItem = $('studyLink').value; // <-- NEW: Get linked item
  if(!hoursInput || hoursInput<=0){ showToast('Enter valid study hours'); return; }
  if(hoursInput>MAX_SESSION_STUDY){ showToast(`Session max ${MAX_SESSION_STUDY} hrs`); return; }
  const today = todayISO(); let todayTotal = totalStudyForDay(today);
  if(todayTotal + hoursInput > MAX_DAILY_STUDY){
    showToast('Daily total capped at 24 hrs. Logging adjusted.');
    const allowed = Math.max(0, MAX_DAILY_STUDY - todayTotal);
    if(allowed <= 0) return;
    const entry = { hours: allowed, category, topic: topic || '', linkedItem: linkedItem || '', ts: new Date().toISOString() }; // <-- Add linkedItem
    const arr = getStudyForDay(today); arr.push(entry); saveStudyForDay(today, arr); 
    $('studyHours').value='';
    $('studyTopic').value=''; // <-- Clear topic
    $('studyLink').value=''; // <-- Clear link
    showToast(`${allowed} hr ${category} added (capped)`);
    updateChartsOnDataChange(); updateTodayQuickStats(); return;
  }
  const entry = { hours: hoursInput, category, topic: topic || '', linkedItem: linkedItem || '', ts: new Date().toISOString() }; // <-- Add linkedItem
  const arr = getStudyForDay(today); arr.push(entry); saveStudyForDay(today, arr); 
  $('studyHours').value='';
  $('studyTopic').value=''; // <-- Clear topic
  $('studyLink').value=''; // <-- Clear link
  showToast(`${hoursInput} hr ${category} added! Great job!`);
  addXP(Math.round(hoursInput*20));
  updateChartsOnDataChange();
  updateTodayQuickStats();
}
function getWorkoutForDay(dayISO){ return read('workouts_' + dayISO, []); }
function saveWorkoutForDay(dayISO, arr){ write('workouts_' + dayISO, arr); }
function totalWorkoutForDay(dayISO){ return getWorkoutForDay(dayISO).reduce((s,x)=>s+(parseInt(x.mins)||0),0); }
function logWorkout(){
  const mins = parseInt($('workoutMins').value || 0);
  if(!mins || mins<=0){ showToast('Enter workout minutes'); return; }
  const today = todayISO(); const arr = getWorkoutForDay(today);
  arr.push({ mins, ts: new Date().toISOString() });
  saveWorkoutForDay(today, arr); $('workoutMins').value='';
  showToast(`${mins} min workout added!`); addXP(Math.round(mins/6));
  updateChartsOnDataChange();
  updateTodayQuickStats();
}
function getWaterForDay(dayISO){ return read('water_' + dayISO, []); }
function saveWaterForDay(dayISO, arr){ write('water_' + dayISO, arr); }
function totalWaterForDay(dayISO){ return getWaterForDay(dayISO).reduce((s,x)=>s+(parseFloat(x.litres)||0),0); }
function logWater() {
    const litres = parseFloat($('waterLitres').value || 0);
    if(!litres || litres <= 0){ showToast('Enter valid litres'); return; }
    const today = todayISO();
    const arr = getWaterForDay(today);
    arr.push({ litres, ts: new Date().toISOString() });
    saveWaterForDay(today, arr);
    $('waterLitres').value='';
    showToast(`${litres.toFixed(1)} L water added! Stay hydrated!`);
    addXP(Math.round(litres * 5));
    updateChartsOnDataChange();
    updateTodayQuickStats();
}
function getMeditationForDay(dayISO){ return read('meditation_' + dayISO, []); }
function saveMeditationForDay(dayISO, arr){ write('meditation_' + dayISO, arr); }
function totalMeditationForDay(dayISO){ return getMeditationForDay(dayISO).reduce((s,x)=>s+(parseInt(x.mins)||0),0); }
function logMeditation() {
    const mins = parseInt($('meditationMins').value || 0);
    if(!mins || mins <= 0){ showToast('Enter valid meditation minutes'); return; }
    const today = todayISO();
    const arr = getMeditationForDay(today);
    arr.push({ mins, ts: new Date().toISOString() });
    saveMeditationForDay(today, arr);
    $('meditationMins').value='';
    showToast(`${mins} min meditation added! Namaste.`);
    addXP(Math.round(mins / 2));
    updateChartsOnDataChange();
    updateTodayQuickStats();
}
function getSleepForDay(dayISO){ return read('sleep_' + dayISO, null); }
function saveSleepForDay(dayISO, obj){ write('sleep_' + dayISO, obj); }
function logSleep(){
  const sleep = $('sleepTime').value; const wake = $('wakeTime').value;
  if(!sleep || !wake){ showToast('Select both sleep and wake times'); return; }
  saveSleepForDay(todayISO(), { sleep, wake, ts: new Date().toISOString() });
  $('sleepTime').value=''; $('wakeTime').value='';
  showToast('Sleep times saved'); updateSleepInfo(); updateChartsOnDataChange();
}
function updateSleepInfo(){
  const s = getSleepForDay(todayISO());
  if(!s){ $('sleepInfo').textContent='No sleep data for today'; return; }
  const sleepDate = new Date(`${todayISO()}T${s.sleep}`); let wakeDate = new Date(`${todayISO()}T${s.wake}`);
  if(wakeDate <= sleepDate) wakeDate.setDate(wakeDate.getDate()+1);
  const diff = (wakeDate - sleepDate)/3600000;
  $('sleepInfo').textContent = `Sleep: ${s.sleep} — Wake: ${s.wake} — Duration: ${diff.toFixed(2)} hrs`;
}
function getTasks(){ return read('tasks', []); }
function saveTasks(arr){ write('tasks', arr); }
function addNewTask(){
  const title = $('newTaskTitle').value.trim();
  if(!title){ showToast('Enter a task title'); return; }
  if($('taskStartTime').value && $('taskEndTime').value && $('taskStartTime').value >= $('taskEndTime').value){ showToast('End time must be after start time'); return; }
  const tasks = getTasks();
  tasks.push({ id: Date.now() + Math.floor(Math.random()*999), title, description: $('newTaskDesc').value.trim(), priority: $('taskPriority').value, category: $('taskCategory').value, startTime: $('taskStartTime').value, endTime: $('taskEndTime').value, completed:false, createdAt: new Date().toISOString() });
  saveTasks(tasks);
  $('newTaskTitle').value=''; $('newTaskDesc').value=''; $('taskPriority').value='low'; $('taskCategory').value='personal'; $('taskStartTime').value=''; $('taskEndTime').value='';
  showToast('Task added'); loadTasks(); updateChartsOnDataChange();
  $('addNewTaskModal').style.display = 'none'; // <-- Close modal on success
}
function addQuickTask(){
  const title = $('quickTaskTitle').value.trim();
  if(!title){ showToast('Enter quick task title'); return; }
  const tasks = getTasks();
  const time = $('quickTaskTime').value; const duration = parseInt($('quickTaskDuration').value || 0);
  const endTime = time && duration ? addDurationToTime(time,duration) : '';
  tasks.push({ id: Date.now() + Math.floor(Math.random()*999), title, description:'', priority:'low', category:'quick', startTime: time||'', endTime, completed:false, createdAt:new Date().toISOString() });
  saveTasks(tasks);
  $('quickTaskTitle').value=''; $('quickTaskTime').value=''; $('quickTaskDuration').value='';
  showToast('Quick task added'); loadTasks(); updateChartsOnDataChange();
  $('quickTaskModal').style.display = 'none'; // <-- Close modal on success
}
function addDurationToTime(timeStr, mins){
  const [hh,mm] = timeStr.split(':').map(Number);
  const dt = new Date(); dt.setHours(hh); dt.setMinutes(mm+mins);
  return `${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;
}
function loadTasks(){
  let tasks = getTasks();
  // Data sanitization: Filter out any malformed tasks that might have been saved due to a bug.
  const originalCount = tasks.length;
  tasks = tasks.filter(t => t && typeof t.title === 'string' && t.id != null);
  if (tasks.length < originalCount) { saveTasks(tasks); } // Resave the cleaned array if anything was removed.

  const priorityOrder = { high: 0, medium: 1, low: 2 };
 
  const active = tasks.filter(t=>!t.completed).sort((a,b)=> {
      const priorityDiff = priorityOrder[a.priority] - priorityOrder[b.priority];
      if (priorityDiff !== 0) return priorityDiff;
      return new Date(b.createdAt) - new Date(a.createdAt); // newest first
  });
 
  const completed = tasks.filter(t=>t.completed).sort((a,b)=>(b.completedAt && a.completedAt) ? new Date(b.completedAt) - new Date(a.completedAt) : 0);
 
  const activeCont = $('activeTasks'); const compCont = $('completedTasks');
  activeCont.innerHTML= active.length===0 ? '<div class="muted">No active tasks</div>' : active.map(t => `
    <div class="task-item">
      <input type="checkbox" class="task-checkbox" onchange="toggleTask(${t.id})">
      <div style="flex:1"> <div style="font-weight:700">${escapeHtml(t.title)}</div> ${t.description? `<div class="muted">${escapeHtml(t.description)}</div>` : ''}
        <div class="task-meta"> <span><i class="fas fa-tag"></i> ${escapeHtml(t.category)}</span> <span class="priority-${t.priority}"><i class="fas fa-flag"></i> ${t.priority}</span> ${t.startTime ? `<span><i class="fas fa-clock"></i> ${t.startTime}${t.endTime? ' - '+t.endTime:''}</span>` : ''} </div>
      </div>
      <div class="task-actions"> <button title="Complete" class="btn small" onclick="toggleTask(${t.id})"><i class="fas fa-check"></i></button> <button title="Delete" class="btn small ghost" onclick="deleteTask(${t.id})"><i class="fas fa-trash"></i></button> </div>
    </div>`).join('');
  compCont.innerHTML= completed.length===0 ? '<div class="muted">No completed tasks</div>' : completed.map(t => `
    <div class="task-item task-completed">
      <input type="checkbox" class="task-checkbox" checked onchange="toggleTask(${t.id})">
      <div style="flex:1"> <div style="font-weight:700">${escapeHtml(t.title)}</div>
        <div class="task-meta"> <span><i class="fas fa-tag"></i> ${escapeHtml(t.category)}</span> <span class="muted">Completed</span> </div>
      </div>
      <div class="task-actions"> <button title="Delete" class="btn small ghost" onclick="deleteTask(${t.id})"><i class="fas fa-trash"></i></button> </div>
    </div>`).join('');
  updateTodayCompletedCount();
}
function toggleTask(id){
  const tasks = getTasks();
  const idx = tasks.findIndex(t=>t.id===id); if(idx===-1) return;

  tasks[idx].completed = !tasks[idx].completed;

  if (tasks[idx].completed) {
    tasks[idx].completedAt = new Date().toISOString();
    showToast('Task completed');
    addXP(8);
  } else {
    delete tasks[idx].completedAt;
    showToast('Task marked active');
  }

  saveTasks(tasks);
  loadTasks(); 
  updateChartsOnDataChange();
  updateTodayQuickStats();
}
function deleteTask(id){
  let tasks = getTasks();
  tasks = tasks.filter(t=>t.id!==id);
  saveTasks(tasks);
  showToast('Task deleted'); loadTasks(); updateChartsOnDataChange();
  updateTodayQuickStats();
}

/* ====== NEW: Learning Journal Functions ====== */
function getLearnings() { return read('learnings', []); }
function saveLearnings(arr) { write('learnings', arr); }

function logLearning() {
    const text = $('modalLearningText').value.trim(); // <-- Changed
    if (!text) {
        showToast('Please enter a learning or win.');
        return;
    }
    const tagsInput = $('modalLearningTags').value.trim(); // <-- Changed
    // Ensure tags are in #tag format, lowercase, and unique
    const tags = [...new Set(
        tagsInput.split(/[\s,]+/)
            .map(t => t.trim().toLowerCase())
            .filter(t => t.length > 1)
            .map(t => t.startsWith('#') ? t : `#${t}`)
    )];
    
    let learnings = getLearnings();
    learnings.push({
        id: Date.now(),
        text: text,
        tags: tags,
        createdAt: new Date().toISOString()
    });
    saveLearnings(learnings);
    
    showToast('Learning logged!');
    $('modalLearningText').value = ''; // <-- Changed
    $('modalLearningTags').value = ''; // <-- Changed
    $('logLearningModal').style.display = 'none'; // <-- NEW
    
    // If user is already on the learnings page, refresh the list
    if ($('learningsSection').classList.contains('active')) {
        loadLearnings(true);
    }
}

function loadLearnings(forceTagRender = false) {
    const allLearnings = getLearnings().reverse(); // Newest first
    const listEl = $('learningsList');
    const tagsEl = $('learningTagFilters');
    const searchTerm = $('learningSearchInput').value.toLowerCase();
    
    // Get selected tags
    const selectedTags = Array.from(tagsEl.querySelectorAll('.tag-filter.active')).map(b => b.dataset.tag);
    
    // 1. (Optional) Re-render tag filter buttons
    if (forceTagRender) {
        const allTags = [...new Set(allLearnings.flatMap(l => l.tags))].sort();
        if (allTags.length === 0) {
            tagsEl.innerHTML = '<div class="muted">No tags added yet.</div>';
        } else {
            tagsEl.innerHTML = allTags.map(tag => 
                `<button class="tag-filter" data-tag="${escapeHtml(tag)}" onclick="toggleTagFilter(this)">
                    ${escapeHtml(tag)}
                </button>`
            ).join('');
        }
    }
    
    // 2. Filter learnings
    const filteredLearnings = allLearnings.filter(l => {
        const textMatch = !searchTerm || l.text.toLowerCase().includes(searchTerm);
        const tagMatch = selectedTags.length === 0 || selectedTags.every(tag => l.tags.includes(tag));
        return textMatch && tagMatch;
    });
    
    // 3. Render filtered list
    if (filteredLearnings.length === 0) {
        listEl.innerHTML = '<div class="muted" style="text-align:center;">No entries found.</div>';
    } else {
        listEl.innerHTML = filteredLearnings.map(l => `
            <div class="learning-item">
                <button class="btn small ghost" onclick="deleteLearning(${l.id})" title="Delete" style="position: absolute; top: 10px; right: 10px; padding: 0.2rem 0.5rem; border-radius: 50%;">
                    <i class="fas fa-trash"></i>
                </button>
                <p style="margin: 0.2rem 0 0.75rem 0; padding-right: 2rem; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(l.text)}</p>
                <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        ${l.tags.map(t => `<span class="tag-badge">${escapeHtml(t)}</span>`).join('')}
                    </div>
                    <div class="muted" style="font-size: 0.8rem; flex-shrink: 0;">
                        ${new Date(l.createdAt).toLocaleString()}
                    </div>
                </div>
            </div>
        `).join('');
    }
}

function toggleTagFilter(buttonEl) {
    buttonEl.classList.toggle('active');
    loadLearnings(false); // Re-filter list, don't re-render tags
}

function deleteLearning(id) {
    let learnings = getLearnings();
    learnings = learnings.filter(l => l.id !== id);
    saveLearnings(learnings);
    showToast('Learning entry deleted.');
    loadLearnings(true); // Force tag re-render in case a tag is now unused
}

/* ====== NEW: Weekly Review Functions ====== */
function triggerWeeklyReview() {
    const today = new Date();
    const todayISOStr = todayISO();
    // Check if it's Sunday (day 0) and review hasn't been done today
    if (today.getDay() === 0 && read('lastWeeklyReview') !== todayISOStr) {
        // Show the prompt modal
        $('weeklyReviewPromptModal').style.display = 'block';
    }
}

function startWeeklyReview() {
    // 1. Get context & build summary (this is instant, no API call)
    const contextData = getAIContextSummary();
    
    const summaryText = `Here's your summary for the past 7 days:
* **Study:** You logged **${contextData.totalStudy} hours**. Your top topics were: ${contextData.recentStudyTopics.length > 0 ? contextData.recentStudyTopics.join(', ') : 'N/A'}.
* **Time by Skill/Project:** ${contextData.linkedTime.length > 0 ? contextData.linkedTime.join(', ') : 'No time linked to specific skills/projects.'}
* **Tasks:** You completed **${contextData.tasksCompleted} tasks** and have **${contextData.activeTasks}** pending.
* **Mind & Body:** You logged **${contextData.totalWorkout} workout minutes** and **${contextData.totalMeditation} meditation minutes**.
* **Mood:** Your average mood was **${contextData.avgMood}**.
* **Learnings:** You logged **${contextData.recentLearnings.length} wins/learnings**.
* **Targets:** Your active weekly targets are: ${contextData.weeklyTargets.length > 0 ? contextData.weeklyTargets.join(', ') : 'None'}.`;

    const aiPrompt = `Hi Ayush! It's time for your 10-minute weekly review.
${summaryText}

---
Now, let's reflect. You can answer all at once or one by one:

1.  **What was your biggest win this week?** (Feel free to check your 'Learnings' log for ideas!)
2.  **What was the biggest challenge or bottleneck?**
3.  **Based on your targets, what is the *one* most important thing to achieve *next* week?**`;

    // 2. Clear chat and pre-populate
    chatHistory = [];
    chatHistory.push({ role: 'ai', text: aiPrompt });
    saveChatHistory();
    
    // 3. Navigate to chat
    showSection('chatSection', document.querySelector('.nav-item[data-target="chatSection"]'));
    renderChat();
    
    // 4. Mark as done and close modal
    write('lastWeeklyReview', todayISO());
    $('weeklyReviewPromptModal').style.display = 'none';
}

// Helper function to get structured data for the review
function getAIContextSummary() {
    const profile = getProfileDetails();
    let totalStudy = 0, totalWorkout = 0, tasksCompleted = 0, moodSum = 0, moodCount = 0, totalMeditation = 0;
    let recentStudyTopics = [];
    const skillsMap = getSkills().reduce((acc, s) => ({ ...acc, [`skill:${s.id}`]: s.name }), {});
    const projectsMap = getProjects().reduce((acc, p) => ({ ...acc, [`project:${p.id}`]: p.name }), {});
    const linkMap = { ...skillsMap, ...projectsMap };
    let linkedTime = {};
    const oneWeekAgo = new Date(datePlusDays(todayISO(), -7)).getTime();
    const recentLearnings = getLearnings()
        .filter(l => new Date(l.createdAt).getTime() >= oneWeekAgo)
        .map(l => l.text.substring(0, 100) + (l.text.length > 100 ? '...' : ''));

    for (let i = 0; i < 7; i++) {
        const day = datePlusDays(todayISO(), -i);
        const studyEntries = getStudyForDay(day);
        studyEntries.forEach(e => {
            const hours = (parseFloat(e.hours) || 0);
            totalStudy += hours;
            if (e.topic) recentStudyTopics.push(e.topic);
            if (e.linkedItem && linkMap[e.linkedItem]) {
                const name = linkMap[e.linkedItem];
                linkedTime[name] = (linkedTime[name] || 0) + hours;
            }
        });
        totalWorkout += totalWorkoutForDay(day);
        totalMeditation += totalMeditationForDay(day);
        tasksCompleted += getTasks().filter(t => t.completed && t.completedAt && t.completedAt.startsWith(day)).length;
        const mood = getMoodForDay(day);
        if (mood) { moodSum += MOOD_MAP[mood.mood] || 0; moodCount++; }
    }
    const activeTasks = getTasks().filter(t => !t.completed).length;
    const weeklyTargets = getTargets().filter(t => t.period === 'week' && !t.completed && isDateInCurrentWeek(t.createdAt)).map(t => t.text);
    
    let avgMood = "Not logged";
    if (moodCount > 0) {
        const avgMoodNum = (moodSum / moodCount);
        const moodNumToText = { 1: 'terrible', 2: 'bad', 3: 'okay', 4: 'good', 5: 'great' };
        avgMood = `${moodNumToText[Math.round(avgMoodNum)]} (${avgMoodNum.toFixed(1)}/5.0)`;
    }
    
    return {
        totalStudy: totalStudy.toFixed(1),
        totalWorkout,
        tasksCompleted,
        totalMeditation,
        recentStudyTopics: [...new Set(recentStudyTopics)].slice(0, 3), // Top 3
        linkedTime: Object.entries(linkedTime).map(([key, val]) => `${key}: ${val.toFixed(1)} hrs`).slice(0, 3),
        activeTasks,
        avgMood,
        recentLearnings,
        weeklyTargets
    };
}


/* ====== NEW: Skill & Project Functions ====== */
function getSkills() { return read('skills', []); }
function saveSkills(arr) { write('skills', arr); }
function getProjects() { return read('projects', []); }
function saveProjects(arr) { write('projects', arr); }

function addSkill() {
    const input = $('newSkillName');
    const name = input.value.trim();
    if (!name) { showToast('Enter a skill name.'); return; }
    let skills = getSkills();
    if (skills.find(s => s.name.toLowerCase() === name.toLowerCase())) {
        showToast('This skill already exists.'); return;
    }
    skills.push({ id: Date.now(), name: name });
    saveSkills(skills);
    input.value = '';
    loadSkillsAndProjects();
    populateStudyLinkDropdown(); // Update dropdown
}

function deleteSkill(id) {
    let skills = getSkills();
    skills = skills.filter(s => s.id !== id);
    saveSkills(skills);
    loadSkillsAndProjects();
    populateStudyLinkDropdown(); // Update dropdown
}

function addProject() {
    const input = $('newProjectName');
    const name = input.value.trim();
    if (!name) { showToast('Enter a project name.'); return; }
    let projects = getProjects();
    if (projects.find(p => p.name.toLowerCase() === name.toLowerCase())) {
        showToast('This project already exists.'); return;
    }
    projects.push({ id: Date.now(), name: name });
    saveProjects(projects);
    input.value = '';
    loadSkillsAndProjects();
    populateStudyLinkDropdown(); // Update dropdown
}

function deleteProject(id) {
    let projects = getProjects();
    projects = projects.filter(p => p.id !== id);
    saveProjects(projects);
    loadSkillsAndProjects();
    populateStudyLinkDropdown(); // Update dropdown
}

function loadSkillsAndProjects() {
    const skills = getSkills();
    const projects = getProjects();
    const skillsList = $('skillsList');
    const projectsList = $('projectsList');

    if (skills.length === 0) {
        skillsList.innerHTML = '<div class="muted" style="text-align:center;">No skills defined.</div>';
    } else {
        skillsList.innerHTML = skills.map(s => `
            <div class="skill-item">
                <span>${escapeHtml(s.name)}</span>
                <button class="btn small ghost" onclick="deleteSkill(${s.id})" title="Delete Skill">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join('');
    }

    if (projects.length === 0) {
        projectsList.innerHTML = '<div class="muted" style="text-align:center;">No projects defined.</div>';
    } else {
        projectsList.innerHTML = projects.map(p => `
            <div class="project-item">
                <span>${escapeHtml(p.name)}</span>
                <button class="btn small ghost" onclick="deleteProject(${p.id})" title="Delete Project">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join('');
    }
}

function populateStudyLinkDropdown() {
    const skills = getSkills();
    const projects = getProjects();
    const select = $('studyLink');
    if (!select) return; // Failsafe if element not present

    let html = '<option value="">-- Link to Skill/Project (Optional) --</option>';
    
    if (skills.length > 0) {
        html += '<optgroup label="Skills">';
        skills.forEach(s => {
            html += `<option value="skill:${s.id}">${escapeHtml(s.name)}</option>`;
        });
        html += '</optgroup>';
    }

    if (projects.length > 0) {
        html += '<optgroup label="Projects">';
        projects.forEach(p => {
            html += `<option value="project:${p.id}">${escapeHtml(p.name)}</option>`;
        });
        html += '</optgroup>';
    }
    
    select.innerHTML = html;
}

/* ====== Target Functions ====== */
function getTargets(){ return read('targets', []); }
function saveTargets(arr){ write('targets', arr); }
function isDateInCurrentWeek(dateStr) {
    if (!dateStr) return false;
    const date = new Date(dateStr);
    const today = new Date();
    const firstDayOfWeek = new Date(today.setDate(today.getDate() - today.getDay()));
    const lastDayOfWeek = new Date(firstDayOfWeek);
    lastDayOfWeek.setDate(lastDayOfWeek.getDate() + 6);
    return date >= firstDayOfWeek && date <= lastDayOfWeek;
}
function isDateInCurrentMonth(dateStr) {
    if (!dateStr) return false;
    const date = new Date(dateStr);
    const today = new Date();
    return date.getMonth() === today.getMonth() && date.getFullYear() === today.getFullYear();
}
function isDateInCurrentYear(dateStr) {
    if (!dateStr) return false;
    const date = new Date(dateStr);
    const today = new Date();
    return date.getFullYear() === today.getFullYear();
}
function addTarget(period) {
    let inputId;
    switch (period) {
        case 'week': inputId = 'newWeeklyTarget'; break;
        case 'month': inputId = 'newMonthlyTarget'; break;
        case 'year': inputId = 'newYearlyTarget'; break;
        default: return;
    }
    const input = $(inputId);
    if (!input) {
        console.error(`Could not find input with ID: ${inputId}`);
        return;
    }
    const text = input.value.trim();
    if (!text) { showToast('Please enter a target.'); return; }
    const targets = getTargets();
    targets.push({ id: Date.now(), text: text, period: period, completed: false, createdAt: new Date().toISOString() });
    saveTargets(targets);
    input.value = '';
    showToast(`${period.charAt(0).toUpperCase() + period.slice(1)} target added!`);
    loadTargets();
}
function loadTargets() {
    const allTargets = getTargets();
    const weeklyList = $('weeklyTargetsList');
    const monthlyList = $('monthlyTargetsList');
    const yearlyList = $('yearlyTargetsList');
   
    const currentWeekTargets = allTargets.filter(t => t.period === 'week' && isDateInCurrentWeek(t.createdAt));
    const currentMonthTargets = allTargets.filter(t => t.period === 'month' && isDateInCurrentMonth(t.createdAt));
    const currentYearTargets = allTargets.filter(t => t.period === 'year' && isDateInCurrentYear(t.createdAt));
   
    const renderList = (targets, container) => {
        if (targets.length === 0) {
            container.innerHTML = `<div class="muted" style="text-align:center; padding: .5rem;">No targets set for this period.</div>`;
            return;
        }
        container.innerHTML = targets.map(t => `
            <div class="target-item ${t.completed ? 'target-completed' : ''}">
                <input type="checkbox" class="target-checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTarget(${t.id})">
                <div style="flex:1;">${escapeHtml(t.text)}</div>
                <div class="target-actions">
                    <button title="Delete" class="btn small ghost" onclick="deleteTarget(${t.id})"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `).join('');
    };
   
    renderList(currentWeekTargets, weeklyList);
    renderList(currentMonthTargets, monthlyList);
    renderList(currentYearTargets, yearlyList);
}
function toggleTarget(id) {
    let targets = getTargets();
    const idx = targets.findIndex(t => t.id === id);
    if (idx !== -1) {
        targets[idx].completed = !targets[idx].completed;
        if(targets[idx].completed) addXP(15);
        saveTargets(targets);
        loadTargets();
    }
}
function deleteTarget(id) {
    let targets = getTargets();
    targets = targets.filter(t => t.id !== id);
    saveTargets(targets);
    showToast('Target deleted.');
    loadTargets();
}

/* ====== Mood Functions ====== */
function getMoodForDay(dayISO){ return read('mood_' + dayISO, null); }
function saveMoodForDay(dayISO, mood){ write('mood_' + dayISO, { mood, ts: new Date().toISOString() }); }

function logMood(mood) {
    saveMoodForDay(todayISO(), mood);
    showToast(`Mood logged as: ${mood}`);
    addXP(5);
    loadTodaysMood();
    updateChartsOnDataChange();
}

function loadTodaysMood() {
    const moodData = getMoodForDay(todayISO());
    const infoEl = $('loggedMoodInfo');
    document.querySelectorAll('.mood-option').forEach(el => el.classList.remove('selected'));

    if (moodData) {
        infoEl.textContent = `You felt ${moodData.mood} today.`;
        const moodEmojiMap = { 'terrible': '😞', 'bad': '😐', 'okay': '🙂', 'good': '😊', 'great': '😄' };
        const emojiToFind = moodEmojiMap[moodData.mood];
        const selectedEl = Array.from(document.querySelectorAll('.mood-option')).find(el => el.textContent === emojiToFind);
        if (selectedEl) {
            selectedEl.classList.add('selected');
        }
    } else {
        infoEl.textContent = 'No mood logged yet.';
    }
}

/* ====== Profile Functions ====== */
function getProfileDetails() { return read('profile_details', {}); }

function saveProfileDetails() {
    const details = {
        name: $('userName').value.trim(),
        age: $('userAge').value.trim(),
        education: $('userEducation').value,
        goal: $('userGoal').value.trim()
    };
    write('profile_details', details);
    showToast('Your details have been saved!');
}

function loadProfileDetails() {
    const details = getProfileDetails();
    $('userName').value = details.name || '';
    $('userAge').value = details.age || '';
    $('userEducation').value = details.education || '';
    $('userGoal').value = details.goal || '';
}

/* ====== XP & Streaks ====== */
function getXP(){ return parseInt(read('xp',0) || 0); }
function setXP(v){ write('xp', v); $('xpPoints').textContent = v; }
function addXP(amount){ setXP(getXP() + amount); }
function updateStreak(){
  let streak = 0;
  for(let i=0;i<365;i++){
    const d = datePlusDays(todayISO(), -i);
    const allTasks = getTasks();
    const hasTaskActivity = allTasks.some(t => (t.createdAt && t.createdAt.startsWith(d)) || (t.completedAt && t.completedAt.startsWith(d)));
    if((getStudyForDay(d).length>0) || (getWorkoutForDay(d).length>0) || hasTaskActivity || getSleepForDay(d) || getMoodForDay(d) || getWaterForDay(d).length > 0 || getMeditationForDay(d).length > 0) streak++; else break;
  }
  write('streak', streak); $('streakCount').textContent = streak;
}

/* ====== Dashboard & Charts ====== */
function initCharts(){
  const chartConfigs = {
    study: { type:'line', el: 'chartStudy', data: { datasets:[{label:'Hours',borderColor:'#2563eb',backgroundColor:'rgba(37,99,235,0.12)',tension:0.3}]}, options:{plugins:{legend:{display:false}}} },
    workout: { type:'line', el: 'chartWorkout', data: { datasets:[{label:'Minutes',borderColor:'#0ea5a4',backgroundColor:'rgba(14,165,164,0.12)',tension:0.3}]}, options:{plugins:{legend:{display:false}}} },
    meditation: { type:'line', el: 'chartMeditation', data: { datasets:[{label:'Minutes',borderColor:'#a78bfa',backgroundColor:'rgba(167,139,250,0.12)',tension:0.3}]}, options:{plugins:{legend:{display:false}}} },
    tasks: { type:'bar', el: 'chartTasks', data: { datasets:[{label:'Completed',backgroundColor:'#2b7cff'}]}, options:{plugins:{legend:{display:false}}} },
    studyByCat: { type:'bar', el: 'chartStudyByCat', data: { datasets:[{label:'Hours',backgroundColor:'#2b7cff'}]} },
    taskTrend: { type:'line', el: 'chartTaskTrend', data: { datasets:[{label:'Completed',borderColor:'#06b6d4',backgroundColor:'rgba(6,182,212,0.12)'}]} },
    sleep: { type:'line', el: 'chartSleep', data: { datasets:[{label:'Sleep hour',borderColor:'#8b5cf6',tension:0.3}, {label:'Wake hour',borderColor:'#f97316',tension:0.3}]}, options:{scales:{y:{min:0,max:24}}} },
    workoutDist: { type:'doughnut', el: 'chartWorkoutDist', data: { datasets:[{backgroundColor:['#2b7cff','#06b6d4','#8b5cf6','#f97316']}]} },
    // NEW: Chart for Study by Skill
    studyBySkill: { type: 'bar', el: 'chartStudyBySkill', data: { datasets:[{label:'Hours', backgroundColor:['#8b5cf6', '#f97316', '#06b6d4', '#2b7cff', '#a78bfa', '#0ea5a4', '#e04f5f']}]}, options: { plugins: { legend: { display: false } }, indexAxis: 'y' } },
    mood: { type: 'line', el: 'chartMood', data: { datasets: [{label:'Mood (1-5)', yAxisID: 'yMood', borderColor: '#f97316', tension: 0.3}, {label:'Tasks Done', yAxisID: 'yTasks', type: 'bar', backgroundColor: 'rgba(43, 124, 255, 0.5)' }] }, options: { scales: { yMood: { type: 'linear', position: 'left', min: 0, max: 6, ticks: { stepSize: 1 } }, yTasks: { type: 'linear', position: 'right', beginAtZero: true, grid: { drawOnChartArea: false } } } } },
    water: { type: 'bar', el: 'chartWater', data: { datasets:[{label:'Litres', backgroundColor:'rgba(37,99,235,0.7)'}]}, options:{plugins:{legend:{display:false}}} },
  };
  for(const key in chartConfigs){
    const config = chartConfigs[key];
    const ctx = $(config.el).getContext('2d');
    charts[key] = new Chart(ctx, { type: config.type, data: { labels: [], datasets: config.data.datasets }, options: { responsive: true, ...config.options } });
  }
}
function updateDashboard(range='weekly'){
  currentDashboardRange = range;
  let days = getRangeDays(range); let labels = [];
  let studyData = [], workoutData = [], tasksData = [], meditationData = [];
  let totalStudy=0, totalWorkout=0, totalTasks=0, totalMeditation=0;
  const allTasks = getTasks();

  if(range==='yearly'){
    for(const month of days){
      labels.push(month); let sumStudy=0, sumWork=0, sumTasks=0, sumMeditation=0;
      const [y,m] = month.split('-'); const daysIn = new Date(y,parseInt(m),0).getDate();
      for(let d=1;d<=daysIn;d++){
        const iso = `${month}-${String(d).padStart(2,'0')}`;
        sumStudy += totalStudyForDay(iso); 
        sumWork += totalWorkoutForDay(iso);
        sumMeditation += totalMeditationForDay(iso);
        sumTasks += allTasks.filter(t => t.completed && t.completedAt && t.completedAt.startsWith(iso)).length;
      }
      studyData.push(Number(sumStudy.toFixed(2))); 
      workoutData.push(sumWork); 
      meditationData.push(sumMeditation);
      tasksData.push(sumTasks);
      totalStudy+=sumStudy; 
      totalWorkout+=sumWork; 
      totalMeditation+=sumMeditation;
      totalTasks+=sumTasks;
    }
  } else {
    for(const day of days){
      labels.push(range==='monthly'? day.split('-')[2] : formatDateLabel(day));
      const s = totalStudyForDay(day); studyData.push(Number(s.toFixed(2))); totalStudy += s;
      const w = totalWorkoutForDay(day); workoutData.push(w); totalWorkout += w;
      const m = totalMeditationForDay(day); meditationData.push(m); totalMeditation += m;
      const t = allTasks.filter(c => c.completed && c.completedAt && c.completedAt.startsWith(day)).length; tasksData.push(t); totalTasks += t;
    }
  }
  $('selStudy').textContent = `${Number(totalStudy.toFixed(2))} hrs`;
  $('selWorkout').textContent = `${totalWorkout} min`;
  $('selMeditation').textContent = `${totalMeditation} min`;
  $('selTasks').textContent = `${totalTasks}`;
  updateStreak(); $('selStreak').textContent = read('streak',0);
  charts.study.data.labels = labels; charts.study.data.datasets[0].data = studyData; charts.study.update();
  charts.workout.data.labels = labels; charts.workout.data.datasets[0].data = workoutData; charts.workout.update();
  charts.meditation.data.labels = labels; charts.meditation.data.datasets[0].data = meditationData; charts.meditation.update();
  charts.tasks.data.labels = labels; charts.tasks.data.datasets[0].data = tasksData; charts.tasks.update();
}
function aggregateStudyByCategory(range){
  const days = getRangeDays(range);
  const categories = { 'College Study':0, 'Online Study':0, 'Self Study':0, 'Coding':0 };
  const processDay = (day) => getStudyForDay(day).forEach(e => { if(categories[e.category]!==undefined) categories[e.category]+=Number(e.hours||0); });
  if(range==='yearly'){
    for(const ym of days){
      const [y,m] = ym.split('-');
      for(let d=1;d<=new Date(y,parseInt(m),0).getDate();d++) processDay(`${ym}-${String(d).padStart(2,'0')}`);
    }
  } else { days.forEach(processDay); }
  return categories;
}
// NEW: Function to aggregate study by linked skill/project
function aggregateStudyByLink(range) {
    const days = getRangeDays(range);
    // Create maps to turn IDs back into names
    const skills = getSkills().reduce((acc, s) => ({ ...acc, [`skill:${s.id}`]: s.name }), {});
    const projects = getProjects().reduce((acc, p) => ({ ...acc, [`project:${p.id}`]: p.name }), {});
    const linkMap = { ...skills, ...projects };
    
    const totals = {};

    const processDay = (day) => {
        getStudyForDay(day).forEach(e => {
            const hours = Number(e.hours || 0);
            // Use the map to get the name, or default to 'Not Linked'
            const key = e.linkedItem && linkMap[e.linkedItem] ? linkMap[e.linkedItem] : 'Not Linked';
            totals[key] = (totals[key] || 0) + hours;
        });
    };

    if (range === 'yearly') {
        for (const ym of days) {
            const [y, m] = ym.split('-');
            for (let d = 1; d <= new Date(y, parseInt(m), 0).getDate(); d++) {
                processDay(`${ym}-${String(d).padStart(2, '0')}`);
            }
        }
    } else {
        days.forEach(processDay);
    }
    
    // Don't show "Not Linked" if it's 0
    if (totals['Not Linked'] === 0) {
        delete totals['Not Linked'];
    }

    return totals;
}

function updateAnalytics(range='weekly'){
  currentAnalyticsRange = range;
  const categories = aggregateStudyByCategory(range);
  charts.studyByCat.data.labels = Object.keys(categories);
  charts.studyByCat.data.datasets[0].data = Object.values(categories).map(v=>Number(v.toFixed(2)));
  charts.studyByCat.update();
  
  // NEW: Update Study by Skill chart
  const linkData = aggregateStudyByLink(range);
  charts.studyBySkill.data.labels = Object.keys(linkData);
  charts.studyBySkill.data.datasets[0].data = Object.values(linkData).map(v => v.toFixed(2));
  charts.studyBySkill.update();
 
  const days = getRangeDays(range); let labels = []; 
  let dataSets = {trend:[], sleepS:[], sleepW:[], workout:[], mood: [], moodTasks: [], water: []};
  const allTasks = getTasks();

  if(range==='yearly'){
     for(const m of days){
        labels.push(m); 
        let trend=0, sS=0, sW=0, w=0, sCnt=0, moodSum=0, moodCnt=0, moodTasksSum=0, waterSum = 0;
        const [y,mm] = m.split('-');
        for(let d=1;d<=new Date(y,parseInt(mm),0).getDate();d++){
            const iso = `${m}-${String(d).padStart(2,'0')}`;
            const dailyTasks = allTasks.filter(t=> t.completed && t.completedAt && t.completedAt.startsWith(iso)).length;
            trend += dailyTasks;
            const s = getSleepForDay(iso);
            if(s){ sS+=Number(s.sleep.split(':')[0]); sW+=Number(s.wake.split(':')[0]); sCnt++; }
            w += totalWorkoutForDay(iso);
            const mood = getMoodForDay(iso);
            if (mood) { moodSum += MOOD_MAP[mood.mood] || 0; moodCnt++; }
            moodTasksSum += dailyTasks;
            waterSum += totalWaterForDay(iso);
        }
        dataSets.trend.push(trend); 
        dataSets.sleepS.push(sCnt ? Number((sS/sCnt).toFixed(2)) : null);
        dataSets.sleepW.push(sCnt ? Number((sW/sCnt).toFixed(2)) : null); 
        dataSets.workout.push(w);
        dataSets.mood.push(moodCnt > 0 ? (moodSum/moodCnt).toFixed(1) : null);
        dataSets.moodTasks.push(moodTasksSum);
        dataSets.water.push(waterSum);
     }
  } else {
    for(const d of days){
        labels.push(formatDateLabel(d));
        const dailyTasks = allTasks.filter(t=> t.completed && t.completedAt && t.completedAt.startsWith(d)).length
        dataSets.trend.push(dailyTasks);
        const s = getSleepForDay(d);
        dataSets.sleepS.push(s ? Number(s.sleep.split(':')[0]) : null);
        dataSets.sleepW.push(s ? Number(s.wake.split(':')[0]) : null);
        dataSets.workout.push(totalWorkoutForDay(d));
        const mood = getMoodForDay(d);
        dataSets.mood.push(mood ? MOOD_MAP[mood.mood] : null);
        dataSets.moodTasks.push(dailyTasks);
        dataSets.water.push(totalWaterForDay(d));
    }
  }
  charts.taskTrend.data.labels = labels; charts.taskTrend.data.datasets[0].data = dataSets.trend; charts.taskTrend.update();
  charts.sleep.data.labels = labels; charts.sleep.data.datasets[0].data = dataSets.sleepS; charts.sleep.data.datasets[1].data = dataSets.sleepW; charts.sleep.update();
  charts.workoutDist.data.labels = labels.slice(0,6); charts.workoutDist.data.datasets[0].data = dataSets.workout.slice(0,6); charts.workoutDist.update();
  charts.mood.data.labels = labels; charts.mood.data.datasets[0].data = dataSets.mood; charts.mood.data.datasets[1].data = dataSets.moodTasks; charts.mood.update();
  charts.water.data.labels = labels; charts.water.data.datasets[0].data = dataSets.water; charts.water.update();
}
function updateChartsOnDataChange(){ 
    if ($('dashboardSection').classList.contains('active')) updateDashboard(currentDashboardRange);
    if ($('analyticsSection').classList.contains('active')) updateAnalytics(currentAnalyticsRange);
}

/* ====== Utilities ====== */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function exportToCSV(){
  const range = currentAnalyticsRange || 'weekly'; const days = getRangeDays(range);
  let rows = [['date','study_hours','study_topics', 'linked_item', 'workout_mins', 'meditation_mins', 'tasks_completed','sleep','wake', 'mood', 'water_litres']]; // <-- Added 'linked_item'
  const allTasks = getTasks();

  // NEW: Create link map for export
  const skillsMap = getSkills().reduce((acc, s) => ({ ...acc, [`skill:${s.id}`]: s.name }), {});
  const projectsMap = getProjects().reduce((acc, p) => ({ ...acc, [`project:${p.id}`]: p.name }), {});
  const linkMap = { ...skillsMap, ...projectsMap };

  if(range==='yearly'){
    for(const m of days){
      let study=0,work=0,tasks=0,sleep='',wake='', moodStr='', water=0, meditation=0;
      let topics = []; let linkedItems = []; // <-- Modified
      const [y,mm]=m.split('-');
      for(let d=1;d<=new Date(y,parseInt(mm),0).getDate();d++){
        const iso = `${m}-${String(d).padStart(2,'0')}`;
        
        const studyEntries = getStudyForDay(iso); // <-- Get entries
        studyEntries.forEach(e => { // <-- Loop entries
            study += (parseFloat(e.hours) || 0);
            if (e.topic) topics.push(e.topic.replace(/"/g, '""')); // Escape quotes in topic
            if (e.linkedItem && linkMap[e.linkedItem]) linkedItems.push(linkMap[e.linkedItem]); // <-- NEW
        });
        
        work += totalWorkoutForDay(iso);
        meditation += totalMeditationForDay(iso);
        tasks += allTasks.filter(t=> t.completed && t.completedAt && t.completedAt.startsWith(iso)).length;
        const s = getSleepForDay(iso); if(s){ sleep = s.sleep; wake = s.wake; }
        const mood = getMoodForDay(iso); if (mood) { moodStr = mood.mood; }
        water += totalWaterForDay(iso);
      }
      rows.push([m, study.toFixed(2), [...new Set(topics)].join('; '), [...new Set(linkedItems)].join('; '), work, meditation, tasks, sleep, wake, moodStr, water.toFixed(2)]); // <-- Modified
    }
  } else {
    for(const d of days){
        const mood = getMoodForDay(d);
        
        const studyEntries = getStudyForDay(d); // <-- Get entries
        const studyHours = studyEntries.reduce((s,x)=>s+(parseFloat(x.hours)||0),0); // <-- Calc hours
        const studyTopics = studyEntries.map(e => e.topic ? e.topic.replace(/"/g, '""') : '').filter(Boolean).join('; '); // <-- Get topics and escape quotes
        const studyLinkedItems = studyEntries.map(e => e.linkedItem && linkMap[e.linkedItem] ? linkMap[e.linkedItem] : '').filter(Boolean).join('; '); // <-- NEW

        rows.push([
            d, 
            studyHours.toFixed(2), // <-- Use new hours
            studyTopics, // <-- Add topics
            studyLinkedItems, // <-- NEW: Add linked items
            totalWorkoutForDay(d), 
            totalMeditationForDay(d), 
            allTasks.filter(t=> t.completed && t.completedAt && t.completedAt.startsWith(d)).length, 
            (getSleepForDay(d)||{}).sleep||'', 
            (getSleepForDay(d)||{}).wake||'', 
            mood ? mood.mood : '', 
            totalWaterForDay(d).toFixed(2)
        ]);
    }
  }
  const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `prod_report_${new Date().toISOString().split('T')[0]}.csv`; a.click();
  URL.revokeObjectURL(a.href);
}

/* ====== Init & bindings ====== */
function updateTodayQuickStats(){
  $('todayDate').textContent = new Date().toLocaleDateString();
  $('todayStudyHours').textContent = `${totalStudyForDay(todayISO()).toFixed(1)} hrs`;
  $('todayWorkout').textContent = `${totalWorkoutForDay(todayISO())} min`;
  $('todayWater').textContent = `${totalWaterForDay(todayISO()).toFixed(1)} L`;
  $('todayMeditation').textContent = `${totalMeditationForDay(todayISO())} min`;
  updateTodayCompletedCount();
}
function updateTodayCompletedCount(){ 
    const today = todayISO();
    $('todayCompletedTasks').textContent = getTasks().filter(t => t.completed && t.completedAt && t.completedAt.startsWith(today)).length; 
}
function loadHomeQuickStats(){ updateTodayQuickStats(); updateSleepInfo(); loadTodaysMood(); populateStudyLinkDropdown(); $('subTitle').textContent = 'Stay focused — check your progress'; } // <-- Modified

function migrateTasks() {
    if (read('tasks_migrated')) return;
    console.log('Running one-time task migration...');
    let allTasks = [];
    // Check the last 365 days for old task data
    for (let i = 0; i < 365; i++) {
        const d = datePlusDays(todayISO(), -i);
        const dailyTasks = read('tasks_' + d);
        if (dailyTasks && dailyTasks.length > 0) {
            allTasks.push(...dailyTasks);
            localStorage.removeItem(STORAGE_PREFIX + 'tasks_' + d); // Clean up old data
        }
    }
    // Remove duplicates by ID, just in case
    const uniqueTasks = allTasks.filter((task, index, self) =>
        index === self.findIndex((t) => (t.id === task.id))
    );
    saveTasks(uniqueTasks);
    write('tasks_migrated', true);
    console.log(`Migration complete. ${uniqueTasks.length} tasks migrated.`);
}

function initialize(){
  migrateTasks();
  setDailyQuote(); setupNotificationButton();
  $('todayDate').textContent = new Date().toLocaleDateString();
  initCharts(); loadHomeQuickStats(); loadTasks(); loadProfileDetails();
  updateDashboard('weekly'); updateAnalytics('weekly');
  
  // AI & Modal events
  $('getMotivationBtn').addEventListener('click', getDailyMotivation);
  $('breakdownBtn').addEventListener('click', breakDownTask);
  $('closeModal').onclick = () => $('aiModal').style.display = 'none';
  
  // API Key Modal Events
  $('addApiKeyBtn').addEventListener('click', () => {
    $('apiKeyInput').value = getApiKey() || ''; // Pre-fill if exists
    $('apiKeyModal').style.display = 'block';
  });
  $('closeApiKeyModal').onclick = () => $('apiKeyModal').style.display = 'none';
  $('saveApiKeyBtn').addEventListener('click', saveApiKey);
  $('removeApiKeyBtn').addEventListener('click', removeApiKey);
  $('apiKeyInput').addEventListener('keyup', (event) => { if (event.key === 'Enter') saveApiKey(); });
  
  // NEW: Quick Task Modal Event
  $('closeQuickTaskModal').onclick = () => $('quickTaskModal').style.display = 'none';

  // NEW: Add Task Modal Event
  $('closeNewTaskModal').onclick = () => $('addNewTaskModal').style.display = 'none';

  // NEW: Log Learning Modal Event
  $('closeLogLearningModal').onclick = () => $('logLearningModal').style.display = 'none';

  window.onclick = (event) => { 
    if (event.target == $('aiModal')) $('aiModal').style.display = "none";
    if (event.target == $('apiKeyModal')) $('apiKeyModal').style.display = "none";
    if (event.target == $('quickTaskModal')) $('quickTaskModal').style.display = "none"; // <-- Add this
    if (event.target == $('addNewTaskModal')) $('addNewTaskModal').style.display = "none"; // <-- Add this
    if (event.target == $('logLearningModal')) $('logLearningModal').style.display = "none"; // <-- NEW
    if (event.target == $('weeklyReviewPromptModal')) $('weeklyReviewPromptModal').style.display = "none"; // <-- NEW
  }
  // Chat events
  $('sendChatBtn').addEventListener('click', handleSendMessage);
  $('chatInput').addEventListener('keyup', (event) => { if (event.key === 'Enter') handleSendMessage(); });
  loadChatHistory();
  // Other events
  $('exportBtn').addEventListener('click', exportToCSV);
  $('darkToggle').addEventListener('click', ()=>{ document.documentElement.classList.toggle('dark'); });
  $('xpPoints').textContent = getXP();
  
  // NEW: Weekly Review Modal Events
  $('closeWeeklyReviewModal').onclick = () => $('weeklyReviewPromptModal').style.display = 'none';
  $('skipWeeklyReviewBtn').onclick = () => $('weeklyReviewPromptModal').style.display = 'none';
  $('startWeeklyReviewBtn').addEventListener('click', startWeeklyReview);

  // NEW: Trigger weekly review check
  triggerWeeklyReview();
}

window.addEventListener('load', initialize);

/* Expose some functions to global (for inline handlers) */
window.showSection = showSection; window.addNewTask = addNewTask; window.loadTasks = loadTasks; window.toggleTask = toggleTask; window.deleteTask = deleteTask; window.logStudy = logStudy; window.logWorkout = logWorkout; window.logWater = logWater; window.logMeditation = logMeditation; window.addQuickTask = addQuickTask; window.logSleep = logSleep; window.updateDashboard = updateDashboard; window.updateAnalytics = updateAnalytics; window.exportToCSV = exportToCSV; 
window.useSuggestion = useSuggestion; window.addTarget = addTarget; window.toggleTarget = toggleTarget; window.deleteTarget = deleteTarget; window.logMood = logMood; window.saveProfileDetails = saveProfileDetails;
window.addSkill = addSkill; window.deleteSkill = deleteSkill; window.addProject = addProject; window.deleteProject = deleteProject; // <-- NEW
window.logLearning = logLearning; window.loadLearnings = loadLearnings; window.toggleTagFilter = toggleTagFilter; window.deleteLearning = deleteLearning; // <-- NEW
window.startWeeklyReview = startWeeklyReview; // <-- NEW

</script>
</body>
</html>

